/* XDS v2.60: Copyright (c) 1999-2011 Excelsior, LLC. All Rights Reserved. */
/* "@(#)IO.c Nov 19  1:11:45 2022" */
/* Generated by XDS Modula-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef IO_H_
#include "IO.h"
#endif
#define IO_C_
#ifndef EXCEPTIONS_H_
#include "EXCEPTIONS.h"
#endif
#ifndef Str_H_
#include "Str.h"
#endif
#ifndef SeqFile_H_
#include "SeqFile.h"
#endif
#ifndef IOChan_H_
#include "IOChan.h"
#endif
#ifndef ChanConsts_H_
#include "ChanConsts.h"
#endif
#ifndef IOConsts_H_
#include "IOConsts.h"
#endif
#ifndef StdChans_H_
#include "StdChans.h"
#endif
#ifndef BiosIO_H_
#include "BiosIO.h"
#endif
#ifndef xtsIO_H_
#include "xtsIO.h"
#endif

IO_RdStrType IO_RdStrRedirect;
IO_WrStrType IO_WrStrRedirect;
X2C_BOOLEAN IO_InputRedirected;
X2C_BOOLEAN IO_OutputRedirected;
X2C_BOOLEAN IO_RdLnOnWr;
X2C_BOOLEAN IO_Prompt;
IO_CHARSET IO_Separators;
X2C_BOOLEAN IO_OK;
X2C_BOOLEAN IO_ChopOff;
X2C_BOOLEAN IO_Eng;
X2C_CHAR IO_PrefixChar;
X2C_CHAR IO_SuffixChar;
#define IO_TrueStr "TRUE"

#define IO_FalseStr "FALSE"

typedef X2C_CHAR StrM[256];

typedef X2C_CHAR Ch2StrT[1];

static X2C_BOOLEAN isLnEmp;

static IOChan_ChanId CidR;

static IOChan_ChanId CidW;

static EXCEPTIONS_ExceptionSource source;


static void RAISE(X2C_CARD32 n, const X2C_CHAR s[], X2C_CARD32 s_len)
{
   X2C_CHAR m[80];
   Str_Concat(m, 80ul, "IO.", 4ul, s, s_len);
   EXCEPTIONS_RAISE(source, n, m, 80ul);
} /* end RAISE() */


extern X2C_BOOLEAN IO_ThreadOK(void)
{
   return IO_OK;
} /* end ThreadOK() */


static void setOK(X2C_BOOLEAN b)
{
   IO_OK = b;
} /* end setOK() */


extern X2C_BOOLEAN IO_KeyPressed(void)
{
   return BiosIO_KeyPressed();
} /* end KeyPressed() */


extern X2C_CHAR IO_RdKey(void)
{
   return BiosIO_RdKey();
} /* end RdKey() */


extern void IO_RdStr(X2C_CHAR s[], X2C_CARD32 s_len)
{
   X2C_CARD32 h;
   X2C_CARD32 i;
   IO_RdStrRedirect(s, s_len);
   h = s_len-1;
   i = 0UL;
   while (i<=h && s[i]) {
      if (s[i]==0xDU  || s[i]==0xAU ) {
         s[i] = 0;
         return;
      }
      ++i;
   }
} /* end RdStr() */


extern void IO_WrStr(X2C_CHAR s[], X2C_CARD32 s_len)
{
   IO_WrStrRedirect(s, s_len);
} /* end WrStr() */

static void FileRdStr(X2C_CHAR [], X2C_CARD32);


static void FileRdStr(X2C_CHAR string[], X2C_CARD32 string_len)
{
   X2C_CARD32 NumRead;
   X2C_CARD32 tmp;
   X2C_CARD8 res;
   X2C_CHAR ch;
   if (IO_Prompt && isLnEmp) IO_WrStr("?", 2ul);
   isLnEmp = 1;
   xtsIO_SetConMode(1, &tmp);
   IOChan_TextRead(CidR, (X2C_ADDRESS)string, (string_len-1)+1UL, &NumRead);
   IOChan_Look(CidR, &ch, &res);
   if (res==IOConsts_endOfLine) IOChan_Skip(CidR);
   xtsIO_SetConMode(0, &tmp);
   if (NumRead<=string_len-1) string[NumRead] = 0;
} /* end FileRdStr() */

static void FileWrStr(const X2C_CHAR [], X2C_CARD32);


static void FileWrStr(const X2C_CHAR string[], X2C_CARD32 string_len)
{
   isLnEmp = 0;
   IOChan_TextWrite(CidW, (X2C_ADDRESS)string, X2C_LENGTH(string,
                string_len));
} /* end FileWrStr() */


extern void IO_RedirectInput(X2C_CHAR FileName[], X2C_CARD32 FileName_len)
{
   IOChan_ChanId cid;
   X2C_CARD8 res;
   SeqFile_OpenRead(&cid, FileName, FileName_len, 0x8U, &res);
   if (res) RAISE(0UL, "RedirectInput: Cannot redirect", 31ul);
   if (IO_InputRedirected) SeqFile_Close(&CidR);
   CidR = cid;
   IO_InputRedirected = 1;
} /* end RedirectInput() */


static void SetStdInput(void)
{
   CidR = StdChans_InChan();
   IO_InputRedirected = 0;
} /* end SetStdInput() */


extern void IO_RedirectOutput(X2C_CHAR FileName[], X2C_CARD32 FileName_len)
{
   IOChan_ChanId cid;
   X2C_CARD8 res;
   SeqFile_OpenWrite(&cid, FileName, FileName_len, 0xCU, &res);
   if (res) RAISE(0UL, "RedirectOutput: Cannot redirect", 32ul);
   if (IO_OutputRedirected) SeqFile_Close(&CidW);
   CidW = cid;
   IO_OutputRedirected = 1;
} /* end RedirectOutput() */


static void SetStdOutput(void)
{
   CidW = StdChans_StdOutChan();
   IO_OutputRedirected = 0;
} /* end SetStdOutput() */

static X2C_CHAR Buffer[256];

static X2C_CARD32 begBf;

static X2C_CARD32 endBf;


static void UpdRdBuff(void)
{
   X2C_CARD32 rsL;
   if (begBf<endBf) return;
   IO_RdStrRedirect(Buffer, 256ul);
   rsL = X2C_LENGTH(Buffer,256ul);
   if (rsL>254UL) rsL = 254UL;
   Buffer[rsL] = '\015';
   ++rsL;
   Buffer[rsL] = '\012';
   ++rsL;
   begBf = 0UL;
   endBf = rsL;
} /* end UpdRdBuff() */


extern void IO_RdLn(void)
{
   begBf = endBf;
} /* end RdLn() */

static IO_CHARSET _cnst = {0x00000001UL,0x00000000UL,0x00000000UL,
                0x00000000UL,0x00000000UL,0x00000000UL,0x00000000UL,
                0x00000000UL};

extern X2C_BOOLEAN IO_EndOfRd(X2C_BOOLEAN Skip)
{
   IO_CHARSET tmp;
   if (Skip) {
      while (begBf<endBf && X2C_INL((X2C_INT32)(X2C_CARD8)Buffer[begBf],256,
                X2C_OR(tmp,IO_Separators,_cnst,8))) ++begBf;
   }
   return begBf>=endBf;
} /* end EndOfRd() */


extern void IO_RdItem(X2C_CHAR V[], X2C_CARD32 V_len)
{
   X2C_CARD32 i;
   X2C_CARD32 L;
   setOK(1);
   L = V_len-1;
   do {
      UpdRdBuff();
      while (begBf<endBf && X2C_INL((X2C_INT32)(X2C_CARD8)Buffer[begBf],256,
                IO_Separators)) ++begBf;
      i = 0UL;
      while ((begBf<endBf && i<=L) && !X2C_INL((X2C_INT32)(X2C_CARD8)
                Buffer[begBf],256,IO_Separators)) {
         V[i] = Buffer[begBf];
         ++begBf;
         ++i;
      }
      if (i<=L) V[i] = 0;
   } while (V[0UL]==0);
} /* end RdItem() */


extern X2C_CHAR IO_RdChar(void)
{
   UpdRdBuff();
   ++begBf;
   return Buffer[begBf-1UL];
} /* end RdChar() */


extern void IO_WrCharRep(X2C_CHAR V, X2C_CARD32 count)
{
   StrM s;
   X2C_CARD32 j;
   X2C_CARD32 i;
   if (IO_RdLnOnWr) IO_RdLn();
   while (count>0UL) {
      i = 254UL;
      if (254UL>count) i = count;
      count -= i;
      j = 0UL;
      while (j<i) {
         s[j] = V;
         ++j;
      }
      s[j] = 0;
      IO_WrStr(s, 256ul);
   }
} /* end WrCharRep() */


extern void IO_WrStrAdj(X2C_CHAR S[], X2C_CARD32 S_len, X2C_INT32 Length)
{
   X2C_CARD32 L;
   X2C_INT32 d;
   if (IO_RdLnOnWr) IO_RdLn();
   setOK(1);
   L = (X2C_CARD32)labs(Length);
   d = (X2C_INT32)(L-X2C_LENGTH(S,S_len));
   if (d<0L && IO_ChopOff) {
      IO_WrCharRep('?', L);
      setOK(0);
      return;
   }
   if (Length>0L && d>0L) IO_WrCharRep(IO_PrefixChar, (X2C_CARD32)d);
   IO_WrStr(S, S_len);
   if (Length<0L && d>0L) IO_WrCharRep(IO_SuffixChar, (X2C_CARD32)d);
} /* end WrStrAdj() */


extern void IO_WrChar(X2C_CHAR V)
{
   if (IO_RdLnOnWr) IO_RdLn();
   IO_WrStr(*(Ch2StrT *) &V, 1ul);
} /* end WrChar() */


extern void IO_WrBool(X2C_BOOLEAN V, X2C_INT32 Length)
{
   if (V) IO_WrStrAdj("TRUE", 5ul, Length);
   else IO_WrStrAdj("FALSE", 6ul, Length);
} /* end WrBool() */


extern void IO_WrShtInt(X2C_INT8 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_IntToStr((X2C_INT32)V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrShtInt() */


extern void IO_WrInt(X2C_INT32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_IntToStr(V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrInt() */


extern void IO_WrLngInt(X2C_INT32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_IntToStr(V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrLngInt() */


extern void IO_WrShtCard(X2C_CARD8 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr((X2C_CARD32)V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrShtCard() */


extern void IO_WrCard(X2C_CARD32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr(V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrCard() */


extern void IO_WrLngCard(X2C_CARD32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr(V, S, 256ul, 10UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrLngCard() */


extern void IO_WrShtHex(X2C_CARD8 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr((X2C_CARD32)V, S, 256ul, 16UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrShtHex() */


extern void IO_WrHex(X2C_CARD32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr(V, S, 256ul, 16UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrHex() */


extern void IO_WrLngHex(X2C_CARD32 V, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_CardToStr(V, S, 256ul, 16UL, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrLngHex() */


extern void IO_WrReal(X2C_REAL V, X2C_CARD32 Precision, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_RealToStr((X2C_LONGREAL)V, Precision, IO_Eng, S, 256ul, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrReal() */


extern void IO_WrFixReal(X2C_REAL V, X2C_CARD32 Precision, X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_FixRealToStr((X2C_LONGREAL)V, Precision, S, 256ul, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrFixReal() */


extern void IO_WrLngReal(X2C_LONGREAL V, X2C_CARD32 Precision,
                X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_RealToStr(V, Precision, IO_Eng, S, 256ul, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrLngReal() */


extern void IO_WrFixLngReal(X2C_LONGREAL V, X2C_CARD32 Precision,
                X2C_INT32 Length)
{
   StrM S;
   X2C_BOOLEAN b;
   Str_FixRealToStr(V, Precision, S, 256ul, &b);
   setOK(b);
   if (b) IO_WrStrAdj(S, 256ul, Length);
} /* end WrFixLngReal() */


extern void IO_WrLn(void)
{
   if (IO_RdLnOnWr) IO_RdLn();
   IO_WrChar('\012');
   isLnEmp = 1;
} /* end WrLn() */


extern X2C_BOOLEAN IO_RdBool(void)
{
   StrM s;
   IO_RdItem(s, 256ul);
   return Str_Compare(s, 256ul, "TRUE", 5ul)==0L;
} /* end RdBool() */


extern X2C_INT8 IO_RdShtInt(void)
{
   StrM S;
   X2C_INT32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToInt(S, 256ul, 10UL, &b);
   setOK((b && i>=-128L) && i<=127L);
   return (X2C_INT8)i;
} /* end RdShtInt() */


extern X2C_INT32 IO_RdInt(void)
{
   StrM S;
   X2C_INT32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToInt(S, 256ul, 10UL, &b);
   setOK((b && i>=X2C_min_longint) && i<=X2C_max_longint);
   return i;
} /* end RdInt() */


extern X2C_INT32 IO_RdLngInt(void)
{
   StrM S;
   X2C_INT32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToInt(S, 256ul, 10UL, &b);
   setOK(b);
   return i;
} /* end RdLngInt() */


extern X2C_CARD8 IO_RdShtCard(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 10UL, &b);
   setOK(b && i<=255UL);
   return (X2C_CARD8)i;
} /* end RdShtCard() */


extern X2C_CARD8 IO_RdShtHex(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 16UL, &b);
   setOK(b && i<=255UL);
   return (X2C_CARD8)i;
} /* end RdShtHex() */


extern X2C_CARD32 IO_RdCard(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 10UL, &b);
   setOK(b && i<=X2C_max_longcard);
   return i;
} /* end RdCard() */


extern X2C_CARD32 IO_RdHex(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 16UL, &b);
   setOK(b && i<=X2C_max_longcard);
   return i;
} /* end RdHex() */


extern X2C_CARD32 IO_RdLngCard(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 10UL, &b);
   setOK(b);
   return i;
} /* end RdLngCard() */


extern X2C_CARD32 IO_RdLngHex(void)
{
   StrM S;
   X2C_CARD32 i;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   i = Str_StrToCard(S, 256ul, 16UL, &b);
   setOK(b);
   return i;
} /* end RdLngHex() */


extern X2C_REAL IO_RdReal(void)
{
   StrM S;
   X2C_LONGREAL r;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   r = Str_StrToReal(S, 256ul, &b);
   setOK((b && r<=(X2C_LONGREAL)X2C_max_real) && r>=(X2C_LONGREAL)
                X2C_min_real);
   if (IO_OK) return (X2C_REAL)r;
   else return 0.0f;
   return 0;
} /* end RdReal() */


extern X2C_LONGREAL IO_RdLngReal(void)
{
   StrM S;
   X2C_LONGREAL r;
   X2C_BOOLEAN b;
   IO_RdItem(S, 256ul);
   r = Str_StrToReal(S, 256ul, &b);
   setOK(b);
   return r;
} /* end RdLngReal() */

static IO_CHARSET _cnst0 = {0x04002600UL,0x00000001UL,0x00000000UL,
                0x00000000UL,0x00000000UL,0x00000000UL,0x00000000UL,
                0x00000000UL};

extern void IO_BEGIN(void)
{
   static int IO_init = 0;
   if (IO_init) return;
   IO_init = 1;
   if (sizeof(IO_CHARSET)!=32) X2C_ASSERT(0);
   if (sizeof(StrM)!=256) X2C_ASSERT(0);
   if (sizeof(Ch2StrT)!=1) X2C_ASSERT(0);
   xtsIO_BEGIN();
   BiosIO_BEGIN();
   IOConsts_BEGIN();
   ChanConsts_BEGIN();
   StdChans_BEGIN();
   IOChan_BEGIN();
   SeqFile_BEGIN();
   Str_BEGIN();
   EXCEPTIONS_BEGIN();
   EXCEPTIONS_AllocateSource(&source);
   SetStdInput();
   SetStdOutput();
   IO_WrStrRedirect = (IO_WrStrType)FileWrStr;
   IO_RdStrRedirect = (IO_RdStrType)FileRdStr;
   begBf = endBf;
   IO_Prompt = 0;
   IO_RdLnOnWr = 0;
   IO_ChopOff = 0;
   memcpy(IO_Separators,_cnst0,32u);
   IO_Eng = 0;
   isLnEmp = 1;
   IO_PrefixChar = ' ';
   IO_SuffixChar = ' ';
   setOK(1);
}

