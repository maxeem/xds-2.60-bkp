/* XDS v2.60: Copyright (c) 1999-2011 Excelsior, LLC. All Rights Reserved. */
/* "@(#)SysClock.c Nov 19  1:11:33 2022" */
/* Generated by XDS Modula-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef SysClock_H_
#include "SysClock.h"
#endif
#define SysClock_C_
#ifndef xlibOS_H_
#include "xlibOS.h"
#endif




extern X2C_BOOLEAN SysClock_CanGetClock(void)
{
   return X2C_CanGetTime();
} /* end CanGetClock() */


extern X2C_BOOLEAN SysClock_CanSetClock(void)
{
   return X2C_CanSetTime();
} /* end CanSetClock() */


static X2C_BOOLEAN is_leap(X2C_CARD32 y)
{
   return (y&3UL)==0UL && y%100UL || y%400UL==0UL;
} /* end is_leap() */

static X2C_CARD32 SysClock_m30days = 0xA50UL;


extern X2C_BOOLEAN SysClock_IsValidDateTime(struct SysClock_DateTime d)
{
   if (d.day<1UL || d.day>31UL) return 0;
   if (d.month<1UL || d.month>12UL) return 0;
   if (d.year<1UL) return 0;
   if (X2C_IN(d.month,32,0xA50UL) && d.day>30UL) return 0;
   if (d.month==2UL && d.day>28UL+(X2C_CARD32)is_leap(d.year)) return 0;
   if ((d.hour>23UL || d.minute>59UL) || d.second>59UL) return 0;
   return 1;
} /* end IsValidDateTime() */


extern void SysClock_GetClock(struct SysClock_DateTime * userData)
{
   struct X2C_TimeStruct t;
   X2C_PROTECTION anonym;
   struct SysClock_DateTime tmp;
   X2C_PROTECT(&anonym,1);
   X2C_GetTime(&t);
   if (t.month<1UL) t.month = 1UL;
   else if (t.month>12UL) t.month = 12UL;
   if (t.day<1UL) t.day = 1UL;
   else if (t.day>31UL) t.day = 31UL;
   if (t.hour>23UL) t.hour = 23UL;
   if (t.min0>59UL) t.min0 = 59UL;
   if (t.sec>59UL) t.sec = 59UL;
   if (t.zone<-780L) t.zone = -780L;
   if (t.zone>720L) t.zone = 720L;
   t.fracs = (t.fracs*100UL)/X2C_FracsPerSec();
   *userData = (tmp.year = t.year, tmp.month = t.month, tmp.day = t.day,
                tmp.hour = t.hour, tmp.minute = t.min0, tmp.second = t.sec,
                tmp.fractions = t.fracs, tmp.zone = t.zone,
                tmp.SummerTimeFlag = t.stf, tmp);
   X2C_PROTECT(&anonym,anonym);
} /* end GetClock() */


extern void SysClock_SetClock(struct SysClock_DateTime d)
{
   struct X2C_TimeStruct rec;
   X2C_CARD32 fr;
   struct X2C_TimeStruct tmp;
   if (!SysClock_IsValidDateTime(d)) return;
   fr = d.fractions;
   fr = (fr*X2C_FracsPerSec())/100UL;
   rec = (tmp.year = d.year, tmp.month = d.month, tmp.day = d.day,
                tmp.hour = d.hour, tmp.min0 = d.minute, tmp.sec = d.second,
                tmp.fracs = fr, tmp.zone = d.zone,
                tmp.stf = d.SummerTimeFlag, tmp);
   X2C_SetTime(&rec);
} /* end SetClock() */


extern void SysClock_BEGIN(void)
{
   static int SysClock_init = 0;
   if (SysClock_init) return;
   SysClock_init = 1;
}

