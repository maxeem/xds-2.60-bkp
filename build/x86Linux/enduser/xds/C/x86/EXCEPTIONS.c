/* XDS v2.60: Copyright (c) 1999-2011 Excelsior, LLC. All Rights Reserved. */
/* "@(#)EXCEPTIONS.c Nov  7 22:55:32 2022" */
/* Generated by XDS Modula-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef EXCEPTIONS_H_
#include "EXCEPTIONS.h"
#endif
#define EXCEPTIONS_C_
#ifndef xmRTS_H_
#include "xmRTS.h"
#endif
#ifndef M2EXCEPTION_H_
#include "M2EXCEPTION.h"
#endif

#define EXCEPTIONS_st_exceptional 1

static X2C_CARD32 EXCEPTIONS_exException = 14UL;


extern void EXCEPTIONS_AllocateSource(EXCEPTIONS_ExceptionSource * newSource)
                
{
   X2C_ADDRESS a;
   X2C_ALLOCATE(&a, sizeof(struct X2C_XSource_STR));
   if (a==0) {
      EXCEPTIONS_RAISE((EXCEPTIONS_ExceptionSource)X2C_rtsSource, 14UL, "Exce\
ption source is not allocated", 34ul);
   }
   *newSource = (EXCEPTIONS_ExceptionSource)a;
   ((X2C_XSource)*newSource)->number = 0UL;
   ((X2C_XSource)*newSource)->message[0U] = 0;
} /* end AllocateSource() */


extern void EXCEPTIONS_RAISE(EXCEPTIONS_ExceptionSource source,
                X2C_CARD32 number, X2C_CHAR message[],
                X2C_CARD32 message_len)
{
   ((X2C_XSource)source)->number = number;
   X2C_COPY(message,message_len,((X2C_XSource)source)->message,1024u);
   X2C_doRaise((X2C_XSource)source);
} /* end RAISE() */


static X2C_XHandler handler(void)
{
   X2C_Coroutine current;
   current = X2C_GetCurrent();
   return current->handler;
} /* end handler() */


extern X2C_CARD32 EXCEPTIONS_CurrentNumber(EXCEPTIONS_ExceptionSource source)
                
{
   X2C_XHandler x;
   x = handler();
   if (x==0 || (X2C_INT32)x->state!=1L) {
      EXCEPTIONS_RAISE((EXCEPTIONS_ExceptionSource)X2C_rtsSource, 14UL, "No c\
urrent exception", 21ul);
   }
   else {
      if (x->source==(X2C_XSource)source) {
         return ((X2C_XSource)source)->number;
      }
      if (x->source==X2C_rtsSource) {
         EXCEPTIONS_RAISE((EXCEPTIONS_ExceptionSource)X2C_rtsSource, 14UL, "N\
ot exception source", 21ul);
      }
      else {
         EXCEPTIONS_RAISE((EXCEPTIONS_ExceptionSource)X2C_rtsSource, 14UL, "N\
ot current source", 19ul);
      }
   }
   X2C_TRAP(X2C_RETURN_TRAP);
   return 0;
} /* end CurrentNumber() */


extern void EXCEPTIONS_GetMessage(X2C_CHAR text[], X2C_CARD32 text_len)
{
   X2C_XHandler x;
   x = handler();
   if (x && (X2C_INT32)x->state==1L) {
      X2C_COPY(x->source->message,1024u,text,text_len);
   }
   else text[0UL] = 0;
} /* end GetMessage() */


extern X2C_BOOLEAN EXCEPTIONS_IsCurrentSource(EXCEPTIONS_ExceptionSource source)
                
{
   X2C_XHandler x;
   x = handler();
   return (x && (X2C_INT32)x->state==1L) && x->source==(X2C_XSource)source;
} /* end IsCurrentSource() */


extern X2C_BOOLEAN EXCEPTIONS_IsExceptionalExecut(void)
{
   X2C_XHandler x;
   x = handler();
   return x && (X2C_INT32)x->state==1L;
} /* end IsExceptionalExecution() */


extern void EXCEPTIONS_BEGIN(void)
{
   static int EXCEPTIONS_init = 0;
   if (EXCEPTIONS_init) return;
   EXCEPTIONS_init = 1;
   M2EXCEPTION_BEGIN();
}

