/* XDS v2.60: Copyright (c) 1999-2011 Excelsior, LLC. All Rights Reserved. */
/* "@(#)Lib.c Nov 19  1:11:54 2022" */
/* Generated by XDS Modula-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef Lib_H_
#include "Lib.h"
#endif
#define Lib_C_
#ifndef ProgEnv_H_
#include "ProgEnv.h"
#endif
#ifndef ProgExec_H_
#include "ProgExec.h"
#endif
#ifndef TextIO_H_
#include "TextIO.h"
#endif
#ifndef TimeConv_H_
#include "TimeConv.h"
#endif
#ifndef SysClock_H_
#include "SysClock.h"
#endif
#ifndef StdChans_H_
#include "StdChans.h"
#endif
#ifndef xtsLib_H_
#include "xtsLib.h"
#endif
#ifndef Str_H_
#include "Str.h"
#endif
#ifndef Strings_H_
#include "Strings.h"
#endif
#ifndef Storage_H_
#include "Storage.h"
#endif


extern X2C_CARD32 Lib_HashString(X2C_CHAR S[], X2C_CARD32 S_len,
                X2C_CARD32 Range)
{
   X2C_CARD32 h;
   X2C_CARD32 i;
   h = 0UL;
   i = 0UL;
   while (i<=S_len-1 && S[i]) {
      h = (X2C_CARD32)((X2C_CARD32)h^(X2C_CARD32)(X2C_CARD32)(X2C_CARD8)S[i])
                ;
      h = (h*8UL&65535UL)+h/8192UL;
      h = h+i&65535UL;
      ++i;
   }
   return h%Range;
} /* end HashString() */


extern void Lib_HSort(X2C_CARD32 N, Lib_CompareProc Less, Lib_SwapProc Swap)
{
   X2C_CARD32 k;
   X2C_CARD32 j;
   X2C_CARD32 i;
   if (N>1UL) {
      i = N/2UL;
      do {
         j = i;
         for (;;) {
            k = j*2UL;
            if (k>N) break;
            if (k<N && Less(k, k+1UL)) ++k;
            if (Less(j, k)) Swap(j, k);
            else break;
            j = k;
         }
         --i;
      } while (i);
      i = N;
      do {
         j = 1UL;
         Swap(1UL, i);
         --i;
         for (;;) {
            k = j*2UL;
            if (k>i) break;
            if (k<i && Less(k, k+1UL)) ++k;
            Swap(j, k);
            j = k;
         }
         for (;;) {
            k = j/2UL;
            if (k>0UL && Less(k, j)) {
               Swap(j, k);
               j = k;
            }
            else break;
         }
      } while (i);
   }
} /* end HSort() */

static void Sort(Lib_SwapProc, Lib_CompareProc, X2C_CARD32, X2C_CARD32);


static void Sort(Lib_SwapProc Swap, Lib_CompareProc Less, X2C_CARD32 l,
                X2C_CARD32 r)
{
   X2C_CARD32 j;
   X2C_CARD32 i;
   while (r>l) {
      i = l+1UL;
      j = r;
      while (i<=j) {
         while (i<=j && !Less(l, i)) ++i;
         while (i<=j && Less(l, j)) --j;
         if (i<=j) {
            Swap(i, j);
            ++i;
            --j;
         }
      }
      if (j!=l) Swap(j, l);
      if (j+j>r+l) {
         Sort(Swap, Less, j+1UL, r);
         r = j-1UL;
      }
      else {
         Sort(Swap, Less, l, j-1UL);
         l = j+1UL;
      }
   }
} /* end Sort() */


extern void Lib_QSort(X2C_CARD32 N, Lib_CompareProc Less, Lib_SwapProc Swap)
{
   Sort(Swap, Less, 1UL, N);
} /* end QSort() */

#define Lib_HistoryMax 54

static X2C_CARD32 History[55];

static X2C_CARD32 HistoryPtr;

static X2C_CARD32 LowerPtr;


static void SetUpHistory(X2C_CARD32 Seed)
{
   X2C_CARD32 x;
   X2C_CARD32 i;
   x = Seed;
   for (i = 0UL; i<=54UL; i++) {
      x = x*0x0BB40E62DUL+17UL;
      History[i] = (X2C_CARD32)(x/65536UL);
   } /* end for */
   HistoryPtr = 54UL;
   LowerPtr = 23UL;
} /* end SetUpHistory() */


extern X2C_CARD32 Lib_RANDOM(X2C_CARD32 Range)
{
   X2C_CARD32 res;
   if (HistoryPtr==0UL) {
      if (LowerPtr==0UL) SetUpHistory(12345UL);
      else {
         HistoryPtr = 54UL;
         --LowerPtr;
      }
   }
   else {
      --HistoryPtr;
      if (LowerPtr==0UL) LowerPtr = 54UL;
      else --LowerPtr;
   }
   res = History[HistoryPtr]+History[LowerPtr];
   History[HistoryPtr] = res;
   if (Range==0UL) return res;
   else return res%Range;
   return 0;
} /* end RANDOM() */


extern void Lib_RANDOMIZE(void)
{
   struct SysClock_DateTime d;
   SysClock_GetClock(&d);
   SetUpHistory((X2C_CARD32)d.fractions*(X2C_CARD32)d.second);
} /* end RANDOMIZE() */


extern X2C_REAL Lib_RAND(void)
{
   X2C_CARD32 x;
   x = Lib_RANDOM(65535UL)+Lib_RANDOM(65535UL)*65536UL;
   return X2C_DIVR((X2C_REAL)x,4.2949672961E+9f);
} /* end RAND() */


extern void Lib_Environment(X2C_CARD32 N, X2C_CHAR result[],
                X2C_CARD32 result_len)
{
   xtsLib_Environment(N, result, result_len);
} /* end Environment() */


extern void Lib_EnvironmentFind(X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_CHAR result[], X2C_CARD32 result_len)
{
   X2C_CHAR * str;
   X2C_CARD32 len;
   X2C_PCOPY((void **)&name,name_len);
   len = ProgEnv_StringLength(name, name_len);
   if (len==0UL) X2C_COPY("",1ul,result,result_len);
   else {
      Storage_ALLOCATE((X2C_ADDRESS *) &str, len+1UL);
      ProgEnv_String(name, name_len, str, 16384ul);
      X2C_COPY(str,16384u,result,result_len);
      Storage_DEALLOCATE((X2C_ADDRESS *) &str, len+1UL);
   }
   X2C_PFREE(name);
} /* end EnvironmentFind() */


extern void Lib_ParamStr(X2C_CHAR S[], X2C_CARD32 S_len, X2C_CARD32 n)
{
   if (n==0UL) ProgEnv_ProgramName(S, S_len);
   else ProgEnv_GetArg(n-1UL, S, S_len);
} /* end ParamStr() */


extern X2C_CARD32 Lib_ParamCount(void)
{
   return ProgEnv_ArgNumber();
} /* end ParamCount() */


extern void Lib_Delay(X2C_CARD32 t)
{
   xtsLib_Delay(t);
} /* end Delay() */


extern void Lib_Speaker(X2C_CARD32 FreqHz, X2C_CARD32 TimeMs)
{
   xtsLib_Speaker(FreqHz, TimeMs);
} /* end Speaker() */


extern X2C_CARD32 Lib_Exec(X2C_CHAR command[], X2C_CARD32 command_len,
                X2C_CHAR Params[], X2C_CARD32 Params_len,
                Lib_ExecEnvPtr Env)
{
   X2C_CARD32 res;
   if (ProgExec_Execute(command, command_len, Params, Params_len, &res)) {
      return res;
   }
   else return 255UL;
   return 0;
} /* end Exec() */


extern X2C_CARD32 Lib_ExecCmd(X2C_CHAR command[], X2C_CARD32 command_len)
{
   X2C_CARD32 res;
   if (ProgExec_Command(command, command_len, &res)) return res;
   else return 255UL;
   return 0;
} /* end ExecCmd() */


extern void Lib_GetTime(X2C_CARD32 * Hrs, X2C_CARD32 * Mins,
                X2C_CARD32 * Secs, X2C_CARD32 * Hsecs)
{
   struct SysClock_DateTime d;
   SysClock_GetClock(&d);
   *Hrs = (X2C_CARD32)d.hour;
   *Mins = (X2C_CARD32)d.minute;
   *Secs = (X2C_CARD32)d.second;
   *Hsecs = (X2C_CARD32)d.fractions;
} /* end GetTime() */


extern void Lib_GetDate(X2C_CARD32 * Year, X2C_CARD32 * Month,
                X2C_CARD32 * Day, X2C_CARD8 * DayOfWeek)
{
   struct SysClock_DateTime d;
   SysClock_GetClock(&d);
   *Year = (X2C_CARD32)d.year;
   *Month = (X2C_CARD32)d.month;
   *Day = (X2C_CARD32)d.day;
   *DayOfWeek = (X2C_CARD8)TimeConv_WeekDay(d);
} /* end GetDate() */


extern void Lib_SetDate(X2C_CARD32 Year, X2C_CARD32 Month, X2C_CARD32 Day)
{
   struct SysClock_DateTime d;
   SysClock_GetClock(&d);
   d.year = Year;
   d.month = (X2C_CARD32)Month;
   d.day = (X2C_CARD32)Day;
   SysClock_SetClock(d);
} /* end SetDate() */


extern void Lib_SetTime(X2C_CARD32 Hrs, X2C_CARD32 Mins, X2C_CARD32 Secs,
                X2C_CARD32 Hsecs)
{
   struct SysClock_DateTime d;
   SysClock_GetClock(&d);
   d.hour = (X2C_CARD32)Hrs;
   d.minute = (X2C_CARD32)Mins;
   d.second = (X2C_CARD32)Secs;
   d.fractions = (X2C_CARD32)Hsecs;
   SysClock_SetClock(d);
} /* end SetTime() */


static void WriteErrorString(const X2C_CHAR errS[], X2C_CARD32 errS_len)
{
   TextIO_WriteString(StdChans_StdErrChan(), errS, errS_len);
   TextIO_WriteLn(StdChans_StdErrChan());
} /* end WriteErrorString() */


extern void Lib_FatalError(X2C_CHAR S[], X2C_CARD32 S_len)
{
   WriteErrorString(S, S_len);
   X2C_ABORT();
} /* end FatalError() */


extern X2C_CARD32 Lib_SysErrno(void)
{
   return 0UL;
} /* end SysErrno() */


extern void Lib_MakeAllPath(X2C_CHAR Path[], X2C_CARD32 Path_len,
                X2C_CHAR Drive[], X2C_CARD32 Drive_len, X2C_CHAR Dir[],
                X2C_CARD32 Dir_len, X2C_CHAR Name[], X2C_CARD32 Name_len,
                X2C_CHAR Ext[], X2C_CARD32 Ext_len)
{
   X2C_CARD32 pos;
   Str_Copy(Path, Path_len, Drive, Drive_len);
   if (Dir[0UL]) {
      Str_Append(Path, Path_len, Dir, Dir_len);
      pos = Strings_Length(Path, Path_len)-1UL;
      if (!(Path[pos]=='\\' || Path[pos]=='/')) {
         Path[pos+1UL] = '\\';
         Path[pos+2UL] = 0;
      }
   }
   Str_Append(Path, Path_len, Name, Name_len);
   if (Ext[0UL]) {
      if (Ext[0UL]!='.') {
         pos = Strings_Length(Path, Path_len);
         Path[pos] = '.';
         Path[pos+1UL] = 0;
      }
      Str_Append(Path, Path_len, Ext, Ext_len);
   }
   return;
} /* end MakeAllPath() */


extern void Lib_SplitAllPath(X2C_CHAR Path[], X2C_CARD32 Path_len,
                X2C_CHAR Drive[], X2C_CARD32 Drive_len, X2C_CHAR Dir[],
                X2C_CARD32 Dir_len, X2C_CHAR Name[], X2C_CARD32 Name_len,
                X2C_CHAR Ext[], X2C_CARD32 Ext_len)
{
   X2C_CARD32 p;
   X2C_CARD32 n;
   X2C_CARD32 path_end;
   X2C_CARD32 ext_start;
   X2C_CARD32 name_start;
   X2C_CARD32 dir_start;
   X2C_CHAR c;
   n = 0UL;
   if (Path[0UL] && (Path[1UL]==':' || Path[2UL]==':')) {
      do {
         c = Path[n];
         Drive[n] = c;
         ++n;
      } while (!(c==':' || n>Drive_len-1));
   }
   if (n<=Drive_len-1) Drive[n] = 0;
   dir_start = n;
   name_start = n;
   ext_start = X2C_max_longcard;
   for (;;) {
      c = Path[n];
      if (c==0) break;
      switch ((unsigned)c) {
      case '.':
         if (!((Path[n+1UL]=='.' || Path[n+1UL]=='\\') || Path[n+1UL]=='/')) {
            ext_start = n;
         }
         ++n;
         break;
      case '/':
      case '\\':
         ++n;
         name_start = n;
         break;
      default:;
         ++n;
         break;
      } /* end switch */
   }
   path_end = n;
   if (ext_start==X2C_max_longcard) ext_start = n;
   n = dir_start;
   p = 0UL;
   while ((n<name_start && p<=Dir_len-1) && n<ext_start) {
      Dir[p] = Path[n];
      ++p;
      ++n;
   }
   if (p<=Dir_len-1) Dir[p] = 0;
   n = name_start;
   p = 0UL;
   while (n<ext_start && p<=Name_len-1) {
      Name[p] = Path[n];
      ++n;
      ++p;
   }
   if (p<=Name_len-1) Name[p] = 0;
   p = 0UL;
   if (ext_start>=name_start) {
      n = ext_start;
      while (n<path_end && p<=Ext_len-1) {
         Ext[p] = Path[n];
         ++n;
         ++p;
      }
   }
   if (p<=Ext_len-1) Ext[p] = 0;
} /* end SplitAllPath() */


extern X2C_ADDRESS Lib_AddAddr(X2C_ADDRESS A, X2C_CARD32 increment)
{
   return (X2C_ADDRESS)((X2C_ADDRESS)A+(X2C_INT32)increment);
} /* end AddAddr() */


extern X2C_ADDRESS Lib_SubAddr(X2C_ADDRESS A, X2C_CARD32 decrement)
{
   return (X2C_ADDRESS)((X2C_ADDRESS)A-(X2C_INT32)decrement);
} /* end SubAddr() */


extern void Lib_IncAddr(X2C_ADDRESS * A, X2C_CARD32 increment)
{
   *A = (X2C_ADDRESS)((X2C_ADDRESS)*A+(X2C_INT32)increment);
} /* end IncAddr() */


extern void Lib_DecAddr(X2C_ADDRESS * A, X2C_CARD32 decrement)
{
   *A = (X2C_ADDRESS)((X2C_ADDRESS)*A-(X2C_INT32)decrement);
} /* end DecAddr() */


extern void Lib_Move(X2C_ADDRESS Source, X2C_ADDRESS Dest, X2C_CARD32 Count)
{
   X2C_INT32 diff;
   if (Count==0UL) return;
   diff = Source-Dest;
   if ((X2C_CARD32)labs(diff)>=Count) X2C_MOVE(Source,Dest,Count);
   else if (diff>0L) {
      while (Count>0UL) {
         *Dest = *Source;
         Source = (X2C_ADDRESS)((X2C_ADDRESS)Source+(X2C_INT32)1UL);
         Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)1UL);
         --Count;
      }
   }
   else if (diff<0L) {
      Source = (X2C_ADDRESS)((X2C_ADDRESS)Source+(X2C_INT32)(Count-1UL));
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)(Count-1UL));
      while (Count>0UL) {
         *Dest = *Source;
         Source = (X2C_ADDRESS)((X2C_ADDRESS)Source-(X2C_INT32)1UL);
         Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest-(X2C_INT32)1UL);
         --Count;
      }
   }
} /* end Move() */


extern void Lib_FastMove(X2C_ADDRESS Source, X2C_ADDRESS Dest,
                X2C_CARD32 Count)
{
   X2C_MOVE(Source,Dest,Count);
} /* end FastMove() */


extern void Lib_WordMove(X2C_ADDRESS Source, X2C_ADDRESS Dest,
                X2C_CARD32 WordCount)
{
   Lib_Move(Source, Dest, WordCount*2UL);
} /* end WordMove() */


extern void Lib_Fill(X2C_ADDRESS Dest, X2C_CARD32 Count, X2C_LOC Value)
{
   memset(Dest,Value,Count);
} /* end Fill() */

typedef X2C_CARD16 * PVAL;


extern void Lib_WordFill(X2C_ADDRESS Dest, X2C_CARD32 WordCount,
                X2C_CARD16 Value)
{
   while (WordCount>0UL) {
      *(PVAL)Dest = Value;
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)2UL);
      --WordCount;
   }
} /* end WordFill() */


extern X2C_CARD32 Lib_ScanR(X2C_ADDRESS Dest, X2C_CARD32 Count,
                X2C_LOC Value)
{
   X2C_CARD32 i;
   i = 0UL;
   while (i<Count) {
      if (*Dest==Value) return i;
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)1UL);
      ++i;
   }
   return i;
} /* end ScanR() */


extern X2C_CARD32 Lib_ScanL(X2C_ADDRESS Dest, X2C_CARD32 Count,
                X2C_LOC Value)
{
   X2C_CARD32 i;
   i = 0UL;
   while (i<Count) {
      if (*Dest==Value) return i;
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest-(X2C_INT32)1UL);
      ++i;
   }
   return i;
} /* end ScanL() */


extern X2C_CARD32 Lib_ScanNeR(X2C_ADDRESS Dest, X2C_CARD32 Count,
                X2C_LOC Value)
{
   X2C_CARD32 i;
   i = 0UL;
   while (i<Count) {
      if (*Dest!=Value) return i;
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)1UL);
      ++i;
   }
   return i;
} /* end ScanNeR() */


extern X2C_CARD32 Lib_ScanNeL(X2C_ADDRESS Dest, X2C_CARD32 Count,
                X2C_LOC Value)
{
   X2C_CARD32 i;
   i = 0UL;
   while (i<Count) {
      if (*Dest!=Value) return i;
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest-(X2C_INT32)1UL);
      ++i;
   }
   return i;
} /* end ScanNeL() */


extern X2C_CARD32 Lib_Compare(X2C_ADDRESS Source, X2C_ADDRESS Dest,
                X2C_CARD32 Len)
{
   X2C_CARD32 i;
   i = 0UL;
   while (i<Len && *Source==*Dest) {
      Source = (X2C_ADDRESS)((X2C_ADDRESS)Source+(X2C_INT32)1UL);
      Dest = (X2C_ADDRESS)((X2C_ADDRESS)Dest+(X2C_INT32)1UL);
      ++i;
   }
   return i;
} /* end Compare() */


extern void Lib_BEGIN(void)
{
   static int Lib_init = 0;
   if (Lib_init) return;
   Lib_init = 1;
   Storage_BEGIN();
   Str_BEGIN();
   xtsLib_BEGIN();
   SysClock_BEGIN();
   StdChans_BEGIN();
   TimeConv_BEGIN();
   TextIO_BEGIN();
   ProgExec_BEGIN();
   ProgEnv_BEGIN();
   HistoryPtr = 0UL;
   LowerPtr = 0UL;
}

