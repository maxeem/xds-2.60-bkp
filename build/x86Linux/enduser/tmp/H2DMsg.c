/* "@(#)H2DMsg.c Nov 19  1:12:04 2022" */
/* Generated by XDS Oberon-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef H2DMsg_H_
#include "H2DMsg.h"
#endif
#define H2DMsg_C_
#ifndef adt_H_
#include "adt.h"
#endif
#ifndef LongStrs_H_
#include "LongStrs.h"
#endif
#ifndef Printf_H_
#include "Printf.h"
#endif
#ifndef IOChan_H_
#include "IOChan.h"
#endif
#ifndef ConvTypes_H_
#include "ConvTypes.h"
#endif
#ifndef WholeStr_H_
#include "WholeStr.h"
#endif
#ifndef SysClock_H_
#include "SysClock.h"
#endif
#ifndef TimeConv_H_
#include "TimeConv.h"
#endif
#ifndef H2DFile_H_
#include "H2DFile.h"
#endif

extern struct X2C_MD_STR H2DMsg_desc;
#define H2DMsg_all_files_exist 150

#define H2DMsg_progress_delay 1

#define H2DMsg_msgs_num 200

#define H2DMsg_no_messages "Message %d (message text is not available)"

#define H2DMsg_mergeMarker "*"

#define H2DMsg_shift 3

struct H2DMsg_LevelDesc;
extern struct X2C_TD_STR H2DMsg_LevelDesc_desc;


static X2C_PROC H2DMsg_StatisticsDesc_proc[] = {
   (X2C_PROC)adt_Compare0,
   (X2C_PROC)adt_SetName,
   (X2C_PROC)H2DMsg_Warning,
   (X2C_PROC)H2DMsg_Error,
   (X2C_PROC)H2DMsg_ShowFooter,
   (X2C_PROC)H2DMsg_ShowHeader
};
static void * H2DMsg_StatisticsDesc_offs[] = {
   X2C_OFS(struct H2DMsg_StatisticsDesc,name),
   X2C_OFS(struct H2DMsg_StatisticsDesc,messages),
   X2C_OFS_END
};
struct X2C_TD_STR H2DMsg_StatisticsDesc_desc = {
   sizeof(struct H2DMsg_StatisticsDesc), "StatisticsDesc",
   &H2DMsg_desc, &H2DMsg_LevelDesc_desc, 6, 2,
   { &adt_ElementDesc_desc, &adt_NamedElementDesc_desc,
                &H2DMsg_StatisticsDesc_desc, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0 },
   H2DMsg_StatisticsDesc_proc, H2DMsg_StatisticsDesc_offs, 0, 0, 0,
                &H2DMsg_StatisticsDesc_desc, 0x93678150lu
};

X2C_BOOLEAN H2DMsg_WasError;
X2C_BOOLEAN H2DMsg_progress;
X2C_INT32 H2DMsg_Line;
X2C_INT32 H2DMsg_Pos;
LongStrs_String H2DMsg_File;
static X2C_INT32 global_lines_num;

static X2C_INT32 global_files_num;

static X2C_INT32 global_errors_num;

static X2C_INT32 global_warnings_num;

static LongStrs_String msgs[200];

static struct SysClock_DateTime begin_time;

static struct SysClock_DateTime progress_time;

static X2C_INT32 progress_line_len;

typedef struct H2DMsg_LevelDesc * Level;


struct H2DMsg_LevelDesc {
   X2C_INT32 _dummy_;
   X2C_INT32 includeLevel;
   X2C_INT32 mergeLevel;
};
static X2C_PROC H2DMsg_LevelDesc_proc[] = {
   (X2C_PROC)adt_Compare
};
static void * H2DMsg_LevelDesc_offs[] = {
   X2C_OFS_END
};
struct X2C_TD_STR H2DMsg_LevelDesc_desc = {
   sizeof(struct H2DMsg_LevelDesc), "LevelDesc",
   &H2DMsg_desc, 0, 1, 1,
   { &adt_ElementDesc_desc, &H2DMsg_LevelDesc_desc, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0 },
   H2DMsg_LevelDesc_proc, H2DMsg_LevelDesc_offs, 0, 0, 0,
                &H2DMsg_LevelDesc_desc, 0x93678150lu
};

static IOChan_ChanId logFile;

static X2C_BOOLEAN logFileExist;

static adt_Stack levelStack;

static Level currLevel;

static IOChan_ChanId dirFile;

static X2C_BOOLEAN dirFileExist;


extern void H2DMsg_Copyright(void)
{
   X2C_SEQ tmp[3];
   Printf_printf("H2D%s(c) 1996-1997 xTech Ltd.\\n", 32ul, (tmp[0].adr = " v1\
.31.0 ", tmp[1].val = 0, tmp[2].val = 10u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
} /* end Copyright() */


extern void H2DMsg_Help(void)
{
   Printf_printf("Usage:\\n", 9ul, 0, 0ul);
   Printf_printf("  Make project:\\n", 18ul, 0, 0ul);
   Printf_printf("    H2D =p  FILENAME\\n", 23ul, 0, 0ul);
   Printf_printf("  Translate:\\n", 15ul, 0, 0ul);
   Printf_printf("    H2D { FILENAME }\\n", 23ul, 0, 0ul);
   X2C_ABORT();
} /* end Help() */


extern void H2DMsg_NewStatistics(H2DMsg_Statistics * s, X2C_CHAR name[],
                X2C_CARD32 name_len)
{
   X2C_NEW(&H2DMsg_StatisticsDesc_desc,(X2C_ADDRESS*)s,
                sizeof(struct H2DMsg_StatisticsDesc),0);
   X2C_CALL(adt_SetName_,X2C_GET_TD(*s),1)((adt_NamedElement)*s, name,
                name_len);
   (*s)->lines = 0L;
   (*s)->errors = 0L;
   (*s)->warnings = 0L;
   adt_NewList(&(*s)->messages);
} /* end NewStatistics() */


extern void H2DMsg_ShowHeader(H2DMsg_Statistics d)
{
   LongStrs_String str = 0;
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   X2C_SEQ tmp[3];
   if (anonym = d->name,anonym->Adr[0]) {
      if (H2DMsg_progress) {
         str = 0;
         LongStrs_Fill(&str, ' ', progress_line_len);
         Printf_printf("%s\\r", 5ul, (tmp[0].adr = str->Adr, tmp[1].val = 0,
                tmp[2].val = str->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
      }
      anonym0 = d->name;
      Printf_printf("File %s\\n", 10ul, (tmp[0].adr = anonym0->Adr,
                tmp[1].val = 0, tmp[2].val = anonym0->Len0*1u-1,
                (X2C_LOC *)tmp), 3ul*sizeof(X2C_SEQ));
   }
} /* end ShowHeader() */


extern void H2DMsg_ShowFooter(H2DMsg_Statistics d)
{
   adt_Element e = 0;
   LongStrs_String str = 0;
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   X2C_SEQ tmp[3];
   if (H2DMsg_progress) {
      str = 0;
      LongStrs_Fill(&str, ' ', progress_line_len);
      Printf_printf("%s\\r", 5ul, (tmp[0].adr = str->Adr, tmp[1].val = 0,
                tmp[2].val = str->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
   }
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(d->messages),6)(d->messages, &e);
   while (e) {
      anonym = ((adt_NamedElement)e)->name;
      Printf_printf("%s\\n", 5ul, (tmp[0].adr = anonym->Adr, tmp[1].val = 0,
                tmp[2].val = anonym->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(d->messages),8)(d->messages, &e);
   }
   if (anonym0 = d->name,anonym0->Adr[0]) {
      Printf_printf("errors %d, warnings %d, lines %d.\\n", 36ul,
                (tmp[0].val = d->errors, tmp[1].val = d->warnings,
                tmp[2].val = d->lines, (X2C_LOC *)tmp), 3ul*sizeof(X2C_SEQ));
      ++global_files_num;
      global_lines_num += d->lines;
      global_warnings_num += d->warnings;
   }
   global_errors_num += d->errors;
} /* end ShowFooter() */


extern void H2DMsg_Error(H2DMsg_Statistics d, X2C_INT32 number,
                X2C_CHAR name[], X2C_CARD32 name_len, X2C_INT32 line,
                X2C_INT32 pos, X2C_LOC x[], X2C_CARD32 x_len)
{
   X2C_CHAR buf[512];
   X2C_CHAR msg[512];
   adt_NamedElement ne = 0;
   LongStrs_String anonym = 0;
   X2C_SEQ tmp[1];
   X2C_SEQ tmp0[8];
   H2DMsg_WasError = 1;
   ++d->errors;
   if (msgs[number]) {
      anonym = msgs[number];
      Printf_sprintf(msg, 512ul, anonym->Adr, anonym->Len0, x, x_len);
   }
   else {
      Printf_sprintf(msg, 512ul, "Message %d (message text is not available)",
                 43ul, (tmp[0].val = number, (X2C_LOC *)tmp),
                sizeof(X2C_SEQ));
   }
   Printf_sprintf(buf, 512ul, "Error [ %s %d:%d ] ** %s", 25ul,
                (tmp0[0].adr = name, tmp0[1].val = 0,
                tmp0[2].val = name_len-1, tmp0[3].val = line,
                tmp0[4].val = pos, tmp0[5].adr = msg, tmp0[6].val = 0,
                tmp0[7].val = 512u-1, (X2C_LOC *)tmp0), 8ul*sizeof(X2C_SEQ));
   X2C_NEW(&adt_NamedElementDesc_desc,(X2C_ADDRESS*) &ne,
                sizeof(struct adt_NamedElementDesc),0);
   X2C_CALL(adt_SetName_,X2C_GET_TD(ne),1)(ne, buf, 512ul);
   X2C_CALL(adt_Insert_0,X2C_GET_TD(d->messages),14)(d->messages,
                (adt_Element)ne);
} /* end Error() */


extern void H2DMsg_Warning(H2DMsg_Statistics d, X2C_INT32 number,
                X2C_CHAR name[], X2C_CARD32 name_len, X2C_INT32 line,
                X2C_INT32 pos, X2C_LOC x[], X2C_CARD32 x_len)
{
   X2C_CHAR buf[512];
   X2C_CHAR msg[512];
   adt_NamedElement ne = 0;
   LongStrs_String anonym = 0;
   X2C_SEQ tmp[1];
   X2C_SEQ tmp0[8];
   ++d->warnings;
   if (msgs[number]) {
      anonym = msgs[number];
      Printf_sprintf(msg, 512ul, anonym->Adr, anonym->Len0, x, x_len);
   }
   else {
      Printf_sprintf(msg, 512ul, "Message %d (message text is not available)",
                 43ul, (tmp[0].val = number, (X2C_LOC *)tmp),
                sizeof(X2C_SEQ));
   }
   Printf_sprintf(buf, 512ul, "Warning [ %s %d:%d ] ** %s", 27ul,
                (tmp0[0].adr = name, tmp0[1].val = 0,
                tmp0[2].val = name_len-1, tmp0[3].val = line,
                tmp0[4].val = pos, tmp0[5].adr = msg, tmp0[6].val = 0,
                tmp0[7].val = 512u-1, (X2C_LOC *)tmp0), 8ul*sizeof(X2C_SEQ));
   X2C_NEW(&adt_NamedElementDesc_desc,(X2C_ADDRESS*) &ne,
                sizeof(struct adt_NamedElementDesc),0);
   X2C_CALL(adt_SetName_,X2C_GET_TD(ne),1)(ne, buf, 512ul);
   X2C_CALL(adt_Insert_0,X2C_GET_TD(d->messages),14)(d->messages,
                (adt_Element)ne);
} /* end Warning() */


extern void H2DMsg_GlobalStatistics(void)
{
   struct SysClock_DateTime curTime;
   X2C_INT32 total_time;
   LongStrs_String anonym = 0;
   X2C_SEQ tmp[3];
   SysClock_GetClock(&curTime);
   total_time = (X2C_INT32)TimeConv_SubDateSecs(curTime, begin_time);
   if (global_files_num==0L && global_errors_num==0L) {
      if (msgs[150UL]) {
         anonym = msgs[150UL];
         Printf_printf("%s", 3ul, (tmp[0].adr = anonym->Adr, tmp[1].val = 0,
                tmp[2].val = anonym->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
      }
      else {
         Printf_printf("Message %d (message text is not available)", 43ul,
                (tmp[0].val = 150UL, (X2C_LOC *)tmp), sizeof(X2C_SEQ));
      }
   }
   else {
      Printf_printf("-----------------------------------------------------\\n\
", 56ul, 0, 0ul);
      Printf_printf("\\rFiles %d, lines %d, ", 23ul,
                (tmp[0].val = global_files_num,
                tmp[1].val = global_lines_num, (X2C_LOC *)tmp),
                2ul*sizeof(X2C_SEQ));
      if (global_errors_num==0L) Printf_printf("no errors, ", 12ul, 0, 0ul);
      else {
         Printf_printf("errors %d, ", 12ul, (tmp[0].val = global_errors_num,
                (X2C_LOC *)tmp), sizeof(X2C_SEQ));
      }
      if (global_warnings_num==0L) {
         Printf_printf("no warnings, ", 14ul, 0, 0ul);
      }
      else {
         Printf_printf("warnings %d, ", 14ul,
                (tmp[0].val = global_warnings_num, (X2C_LOC *)tmp),
                sizeof(X2C_SEQ));
      }
      if (X2C_DIV(total_time,3600L)>0L) {
         Printf_printf("time: %d:%d:%d.\\n", 18ul,
                (tmp[0].val = X2C_DIV(total_time,3600L),
                tmp[1].val = X2C_DIV(X2C_MOD(total_time,3600L),60L),
                tmp[2].val = X2C_MOD(X2C_MOD(total_time,3600L),60L),
                (X2C_LOC *)tmp), 3ul*sizeof(X2C_SEQ));
      }
      else {
         Printf_printf("time %d:%d.\\n", 14ul,
                (tmp[0].val = X2C_DIV(total_time,60L),
                tmp[1].val = X2C_MOD(total_time,60L), (X2C_LOC *)tmp),
                2ul*sizeof(X2C_SEQ));
      }
   }
} /* end GlobalStatistics() */


extern void H2DMsg_Error0(X2C_INT32 number, X2C_LOC x[], X2C_CARD32 x_len)
{
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   X2C_SEQ tmp[1];
   X2C_SEQ tmp0[5];
   H2DMsg_WasError = 1;
   if (H2DMsg_File==0) {
      Printf_printf("Error [ ] ** ", 14ul, 0, 0ul);
      if (msgs[number]) {
         anonym = msgs[number];
         Printf_printf(anonym->Adr, anonym->Len0, x, x_len);
      }
      else {
         Printf_printf("Message %d (message text is not available)", 43ul,
                (tmp[0].val = number, (X2C_LOC *)tmp), sizeof(X2C_SEQ));
      }
      Printf_printf("\\n", 3ul, 0, 0ul);
   }
   else {
      Printf_printf("Error [ %s %d:%d ] ** ", 23ul,
                (tmp0[0].adr = H2DMsg_File->Adr, tmp0[1].val = 0,
                tmp0[2].val = H2DMsg_File->Len0*1u-1,
                tmp0[3].val = H2DMsg_Line, tmp0[4].val = H2DMsg_Pos,
                (X2C_LOC *)tmp0), 5ul*sizeof(X2C_SEQ));
      if (msgs[number]) {
         anonym0 = msgs[number];
         Printf_printf(anonym0->Adr, anonym0->Len0, x, x_len);
      }
      else {
         Printf_printf("Message %d (message text is not available)", 43ul,
                (tmp0[0].val = number, (X2C_LOC *)tmp0), sizeof(X2C_SEQ));
      }
      Printf_printf("\\n", 3ul, 0, 0ul);
   }
} /* end Error() */


extern void H2DMsg_Warning0(X2C_INT32 number, X2C_LOC x[], X2C_CARD32 x_len)
{
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   X2C_SEQ tmp[1];
   X2C_SEQ tmp0[5];
   if (H2DMsg_File==0) {
      Printf_printf("Warning [ ] ** ", 16ul, 0, 0ul);
      if (msgs[number]) {
         anonym = msgs[number];
         Printf_printf(anonym->Adr, anonym->Len0, x, x_len);
      }
      else {
         Printf_printf("Message %d (message text is not available)", 43ul,
                (tmp[0].val = number, (X2C_LOC *)tmp), sizeof(X2C_SEQ));
      }
      Printf_printf("\\n", 3ul, 0, 0ul);
   }
   else {
      Printf_printf("Warning [ %s %d:%d ] ** ", 25ul,
                (tmp0[0].adr = H2DMsg_File->Adr, tmp0[1].val = 0,
                tmp0[2].val = H2DMsg_File->Len0*1u-1,
                tmp0[3].val = H2DMsg_Line, tmp0[4].val = H2DMsg_Pos,
                (X2C_LOC *)tmp0), 5ul*sizeof(X2C_SEQ));
      if (msgs[number]) {
         anonym0 = msgs[number];
         Printf_printf(anonym0->Adr, anonym0->Len0, x, x_len);
      }
      else {
         Printf_printf("Message %d (message text is not available)", 43ul,
                (tmp0[0].val = number, (X2C_LOC *)tmp0), sizeof(X2C_SEQ));
      }
      Printf_printf("\\n", 3ul, 0, 0ul);
   }
} /* end Warning() */


extern void H2DMsg_Progress0(X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_INT32 line)
{
   struct SysClock_DateTime curTime;
   X2C_CHAR buf[200];
   LongStrs_String str = 0;
   X2C_INT32 len;
   X2C_SEQ tmp[4];
   if (H2DMsg_progress) {
      SysClock_GetClock(&curTime);
      if (TimeConv_SubDateSecs(curTime, progress_time)>1UL) {
         str = 0;
         Printf_sprintf(buf, 200ul, "File %s, line %d", 17ul,
                (tmp[0].adr = name, tmp[1].val = 0, tmp[2].val = name_len-1,
                tmp[3].val = line, (X2C_LOC *)tmp), 4ul*sizeof(X2C_SEQ));
         len = LongStrs_Length(buf, 200ul);
         LongStrs_Fill(&str, ' ', progress_line_len-len);
         LongStrs_Insert(buf, 200ul, 0L, &str);
         progress_line_len = len;
         Printf_printf("%s\\r", 5ul, (tmp[0].adr = str->Adr, tmp[1].val = 0,
                tmp[2].val = str->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
         SysClock_GetClock(&progress_time);
      }
   }
} /* end Progress() */


static void writeLogFile(const X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_BOOLEAN merge)
{
   LongStrs_String str = 0;
   if (merge) {
      H2DFile_SpaceStr(&str, currLevel->mergeLevel);
      H2DFile_WrStrLn(logFile, str->Adr, str->Len0);
      H2DFile_WrStr(logFile, "*", 2ul);
      H2DFile_SpaceStr(&str, (currLevel->includeLevel-currLevel->mergeLevel)-1L);
      H2DFile_WrStr(logFile, str->Adr, str->Len0);
      H2DFile_WrStr(logFile, name, name_len);
   }
   else {
      H2DFile_SpaceStr(&str, currLevel->includeLevel);
      H2DFile_WrStrLn(logFile, str->Adr, str->Len0);
      H2DFile_WrStr(logFile, name, name_len);
   }
} /* end writeLogFile() */


extern void H2DMsg_OpenLogFile(X2C_CHAR wholename[],
                X2C_CARD32 wholename_len, X2C_CHAR ext[], X2C_CARD32 ext_len,
                 H2DMsg_Statistics stat)
{
   LongStrs_String logname = 0;
   LongStrs_String name = 0;
   X2C_SEQ tmp[3];
   H2DFile_GetName(wholename, wholename_len, &name);
   H2DFile_CreateName("", 1ul, name->Adr, name->Len0, ext, ext_len,
                &logname);
   if (H2DFile_Open(logname->Adr, logname->Len0, 2L, &logFile, 0x8U)) {
      adt_NewStack(&levelStack);
      X2C_NEW(&H2DMsg_LevelDesc_desc,(X2C_ADDRESS*) &currLevel,
                sizeof(struct H2DMsg_LevelDesc),0);
      currLevel->includeLevel = 0L;
      currLevel->mergeLevel = 2L;
      X2C_CALL(adt_Push_,X2C_GET_TD(levelStack),3)(levelStack,
                (adt_Element)currLevel);
      writeLogFile(wholename, wholename_len, 0);
      currLevel->includeLevel = 3L;
      logFileExist = 1;
   }
   else {
      X2C_CALL(H2DMsg_Warning_,X2C_GET_TD(stat),2)(stat, 6L, wholename,
                wholename_len, 0L, 0L, (tmp[0].adr = logname->Adr,
                tmp[1].val = 0, tmp[2].val = logname->Len0*1u-1,
                (X2C_LOC *)tmp), 3ul*sizeof(X2C_SEQ));
   }
   LongStrs_Deallocate(&name);
   LongStrs_Deallocate(&logname);
} /* end OpenLogFile() */


extern void H2DMsg_WriteLogFile(X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_BOOLEAN merge)
{
   adt_Element e = 0;
   Level l = 0;
   if (logFileExist) {
      if (name[0]==0) {
         X2C_CALL(adt_Pop_,X2C_GET_TD(levelStack),2)(levelStack, &e);
         X2C_CALL(adt_Pop_,X2C_GET_TD(levelStack),2)(levelStack, &e);
         if (e) {
            currLevel = (Level)e;
            X2C_CALL(adt_Push_,X2C_GET_TD(levelStack),3)(levelStack, e);
         }
      }
      else {
         writeLogFile(name, name_len, merge);
         X2C_NEW(&H2DMsg_LevelDesc_desc,(X2C_ADDRESS*) &l,
                sizeof(struct H2DMsg_LevelDesc),0);
         l->includeLevel = currLevel->includeLevel+3L;
         if (merge) l->mergeLevel = currLevel->mergeLevel;
         else l->mergeLevel = l->includeLevel-1L;
         X2C_CALL(adt_Push_,X2C_GET_TD(levelStack),3)(levelStack,
                (adt_Element)l);
         currLevel = l;
      }
   }
} /* end WriteLogFile() */


extern void H2DMsg_CloseLogFile(void)
{
   if (logFileExist) {
      H2DFile_Close(logFile);
      logFileExist = 0;
   }
} /* end CloseLogFile() */


extern void H2DMsg_OpenDirFile(X2C_CHAR wholename[],
                X2C_CARD32 wholename_len, X2C_CHAR ext[],
                X2C_CARD32 ext_len)
{
   LongStrs_String dirname = 0;
   LongStrs_String name = 0;
   X2C_SEQ tmp[3];
   H2DFile_GetName(wholename, wholename_len, &name);
   H2DFile_CreateName("", 1ul, name->Adr, name->Len0, ext, ext_len,
                &dirname);
   if (H2DFile_Open(dirname->Adr, dirname->Len0, 2L, &dirFile, 0x8U)) {
      dirFileExist = 1;
   }
   else {
      H2DMsg_Warning0(6L, (tmp[0].adr = dirname->Adr, tmp[1].val = 0,
                tmp[2].val = dirname->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
   }
   LongStrs_Deallocate(&name);
   LongStrs_Deallocate(&dirname);
} /* end OpenDirFile() */


extern void H2DMsg_WriteDirFile(X2C_CHAR str[], X2C_CARD32 str_len)
{
   if (dirFileExist) H2DFile_WrStrLn(dirFile, str, str_len);
} /* end WriteDirFile() */


extern void H2DMsg_CloseDirFile(void)
{
   if (dirFileExist) {
      H2DFile_Close(dirFile);
      dirFileExist = 0;
   }
} /* end CloseDirFile() */


static void get_msg(X2C_INT32 line, X2C_INT32 * num, LongStrs_String * str)
{
   X2C_INT32 i;
   LongStrs_String numstr = 0;
   X2C_CARD8 res;
   X2C_SEQ tmp[1];
   i = 0L;
   while ((X2C_CARD8)(*str)->Adr[i]>='0' && (X2C_CARD8)(*str)->Adr[i]<='9') {
      ++i;
   }
   numstr = 0;
   LongStrs_Extract((*str)->Adr, (*str)->Len0, 0L, i, &numstr);
   LongStrs_Delete((*str)->Adr, (*str)->Len0, 0L, i);
   H2DFile_CutSpace((*str)->Adr, (*str)->Len0);
   WholeStr_StrToInt(numstr->Adr, numstr->Len0, num, &res);
   LongStrs_Deallocate(&numstr);
   if (res) {
      H2DMsg_WasError = 1;
      Printf_printf("\\nError [ h2d.msg %d:0 ] ** Wrong message format.\\n",
                52ul, (tmp[0].val = line, (X2C_LOC *)tmp), sizeof(X2C_SEQ));
   }
   else if (*num>200L) {
      H2DMsg_WasError = 1;
      Printf_printf("\\nError [ h2d.msg %d:0 ] ** Incorrect message number.\\\
n", 56ul, (tmp[0].val = line, (X2C_LOC *)tmp), sizeof(X2C_SEQ));
   }
   else LongStrs_Assign((*str)->Adr, (*str)->Len0, &msgs[*num]);
} /* end get_msg() */


static void ReadMsgs(void)
{
   IOChan_ChanId f;
   X2C_INT32 i;
   LongStrs_String name = 0;
   LongStrs_String str = 0;
   X2C_INT32 num;
   X2C_INT32 line;
   X2C_SEQ tmp[3];
   str = 0;
   name = 0;
   for (i = 0L; i<=199L; i++) {
      msgs[i] = 0;
   } /* end for */
   H2DFile_CreateName("", 1ul, H2DFile_ProgramName->Adr,
                H2DFile_ProgramName->Len0, "msg", 4ul, &name);
   if (H2DFile_Open(name->Adr, name->Len0, 1L, &f, 0x8U)) {
      H2DFile_RdStr(f, &str);
      line = 1L;
      while (str) {
         if (LongStrs_Length(str->Adr, str->Len0)>0L && str->Adr[0UL]!='%') {
            get_msg(line, &num, &str);
            if (H2DMsg_WasError) return;
         }
         H2DFile_RdStr(f, &str);
         ++line;
      }
   }
   else {
      Printf_printf("\\nError [ ] ** Can\'t open file \'%s\'.\\n", 39ul,
                (tmp[0].adr = name->Adr, tmp[1].val = 0,
                tmp[2].val = name->Len0*1u-1, (X2C_LOC *)tmp),
                3ul*sizeof(X2C_SEQ));
      H2DMsg_WasError = 1;
   }
   LongStrs_Deallocate(&str);
   LongStrs_Deallocate(&name);
} /* end ReadMsgs() */


static void * H2DMsg_offs[] = {
   &H2DMsg_File,
   X2C_OFS_ARR,
   &msgs[199],
   &msgs[0],
   &levelStack,
   &currLevel,
   X2C_OFS_END
};
static X2C_PROC H2DMsg_cmds[] = { H2DMsg_CloseDirFile,H2DMsg_CloseLogFile,
                H2DMsg_Copyright,H2DMsg_GlobalStatistics,H2DMsg_Help,0 };
static X2C_CHAR * H2DMsg_cnms[] = { "CloseDirFile","CloseLogFile",
                "Copyright","GlobalStatistics","Help",0 };
struct X2C_MD_STR H2DMsg_desc = {
  0, 0, "H2DMsg",H2DMsg_offs,H2DMsg_cmds,H2DMsg_cnms,
                &H2DMsg_StatisticsDesc_desc
};

extern void H2DMsg_BEGIN(void)
{
   static int H2DMsg_init = 0;
   if (H2DMsg_init) return;
   H2DMsg_init = 1;
   ConvTypes_BEGIN();
   WholeStr_BEGIN();
   H2DFile_BEGIN();
   LongStrs_BEGIN();
   Printf_BEGIN();
   TimeConv_BEGIN();
   SysClock_BEGIN();
   adt_BEGIN();
   X2C_MODULE(&H2DMsg_desc);
   SysClock_GetClock(&begin_time);
   global_lines_num = 0L;
   global_files_num = 0L;
   global_errors_num = 0L;
   global_warnings_num = 0L;
   H2DMsg_WasError = 0;
   H2DMsg_progress = 0;
   progress_line_len = 0L;
   SysClock_GetClock(&progress_time);
   logFile = 0;
   logFileExist = 0;
   H2DMsg_Copyright();
   ReadMsgs();
}

