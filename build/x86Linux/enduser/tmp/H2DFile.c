/* "@(#)H2DFile.c Nov  7 22:56:04 2022" */
/* Generated by XDS Oberon-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef H2DFile_H_
#include "H2DFile.h"
#endif
#define H2DFile_C_
#ifndef Printf_H_
#include "Printf.h"
#endif
#ifndef IOChan_H_
#include "IOChan.h"
#endif
#ifndef ChanConsts_H_
#include "ChanConsts.h"
#endif
#ifndef IOConsts_H_
#include "IOConsts.h"
#endif
#ifndef adt_H_
#include "adt.h"
#endif
#ifndef LongStrs_H_
#include "LongStrs.h"
#endif
#ifndef Strings_H_
#include "Strings.h"
#endif
#ifndef RndFile_H_
#include "RndFile.h"
#endif
#ifndef RawIO_H_
#include "RawIO.h"
#endif
#ifndef TextIO_H_
#include "TextIO.h"
#endif
#ifndef FileSys_H_
#include "FileSys.h"
#endif
#ifndef platform_H_
#include "platform.h"
#endif
#ifndef RegComp_H_
#include "RegComp.h"
#endif
#ifndef ProgEnv_H_
#include "ProgEnv.h"
#endif

extern struct X2C_MD_STR H2DFile_desc;
X2C_INT32 H2DFile_SizeOutputLine;
LongStrs_String H2DFile_DivideChars;
LongStrs_String H2DFile_CurrentDir;
LongStrs_String H2DFile_ProgramName;
X2C_BOOLEAN H2DFile_UnlimitedSizeOutputLin;
static adt_NamedElement curDir;

static X2C_CARD8 H2DFile_read = 0x1U;

static X2C_CARD8 H2DFile_write = 0x2U;

static X2C_CARD8 H2DFile_read_write = 0x3U;

static X2C_CARD8 H2DFile_create = 0x7U;

X2C_CARD8 H2DFile_text_file = 0x8U;
X2C_CARD8 H2DFile_raw_file = 0x10U;
#define H2DFile_comment_character "%"

#define H2DFile_default_cur_dir ""

#define H2DFile_ext_prefix "*"

#define H2DFile_point "."

#define H2DFile_space " "

#define H2DFile_point_com ";"

#define H2DFile_equal "="

#define H2DFile_Box_size 150

#define H2DFile_default_size_output_li 86

#define H2DFile_unknown (-2)

#define H2DFile_none (-1)

struct H2DFile_BufferDesc;
extern struct X2C_TD_STR H2DFile_BufferDesc_desc;

typedef struct H2DFile_BufferDesc * Buffer;


struct H2DFile_BufferDesc {
   X2C_INT32 _dummy_;
   X2C_CHAR box[150];
};
static X2C_PROC H2DFile_BufferDesc_proc[] = {
   (X2C_PROC)adt_Compare
};
static void * H2DFile_BufferDesc_offs[] = {
   X2C_OFS_END
};
struct X2C_TD_STR H2DFile_BufferDesc_desc = {
   sizeof(struct H2DFile_BufferDesc), "BufferDesc",
   &H2DFile_desc, 0, 1, 1,
   { &adt_ElementDesc_desc, &H2DFile_BufferDesc_desc, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0 },
   H2DFile_BufferDesc_proc, H2DFile_BufferDesc_offs, 0, 0, 0,
                &H2DFile_BufferDesc_desc, 0x93678150lu
};

struct H2DFile_GroupDesc;
extern struct X2C_TD_STR H2DFile_GroupDesc_desc;

typedef struct H2DFile_GroupDesc * Group;


struct H2DFile_GroupDesc {
   X2C_INT32 _dummy_;
   LongStrs_String name;
   RegComp_Expr expr;
   adt_List pathes;
};
static X2C_PROC H2DFile_GroupDesc_proc[] = {
   (X2C_PROC)adt_Compare0,
   (X2C_PROC)adt_SetName
};
static void * H2DFile_GroupDesc_offs[] = {
   X2C_OFS(struct H2DFile_GroupDesc,name),
   X2C_OFS(struct H2DFile_GroupDesc,expr),
   X2C_OFS(struct H2DFile_GroupDesc,pathes),
   X2C_OFS_END
};
struct X2C_TD_STR H2DFile_GroupDesc_desc = {
   sizeof(struct H2DFile_GroupDesc), "GroupDesc",
   &H2DFile_desc, &H2DFile_BufferDesc_desc, 2, 2,
   { &adt_ElementDesc_desc, &adt_NamedElementDesc_desc,
                &H2DFile_GroupDesc_desc, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0 },
   H2DFile_GroupDesc_proc, H2DFile_GroupDesc_offs, 0, 0, 0,
                &H2DFile_GroupDesc_desc, 0x93678150lu
};

static adt_List PathStore;

static X2C_CARD8 OpenResults;

static LongStrs_String extSep0;

static LongStrs_String pathSep0;

static LongStrs_String BlankString;

static LongStrs_String outStr;


static void CleanBuffer(adt_List * b)
{
   adt_Element e = 0;
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(*b),6)(*b, &e);
   while (e) {
      adt_Deallocate(e);
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(*b),8)(*b, &e);
   }
   adt_Deallocate((adt_Element)*b);
   *b = 0;
} /* end CleanBuffer() */


static void NewGroup(Group * group)
{
   X2C_NEW(&H2DFile_GroupDesc_desc,(X2C_ADDRESS*)group,
                sizeof(struct H2DFile_GroupDesc),0);
   (*group)->expr = 0;
   adt_NewList(&(*group)->pathes);
} /* end NewGroup() */


static X2C_INT32 Length(const X2C_CHAR str[], X2C_CARD32 str_len)
{
   X2C_INT32 size;
   X2C_INT32 pos;
   pos = 0L;
   size = str_len;
   while (pos<size && str[pos]) ++pos;
   return pos;
} /* end Length() */


extern void H2DFile_CutSpace(X2C_CHAR str[], X2C_CARD32 str_len)
{
   X2C_INT32 pos;
   X2C_INT32 size;
   size = LongStrs_Length(str, str_len);
   if (size==0L) return;
   pos = size-1L;
   while (pos>=0L && str[pos]==' ') --pos;
   Strings_Delete(str, str_len, (X2C_CARD32)(pos+1L),
                (X2C_CARD32)((size-pos)-1L));
   pos = 0L;
   while (pos<size && str[pos]==' ') ++pos;
   Strings_Delete(str, str_len, 0UL, (X2C_CARD32)pos);
} /* end CutSpace() */


static void FlushBuffer(adt_List buffer, LongStrs_String * str)
{
   adt_Element elm = 0;
   LongStrs_Assign("", 1ul, str);
   X2C_CALL(adt_Reset_,X2C_GET_TD(buffer),9)(buffer);
   X2C_CALL(adt_FindNext_0,X2C_GET_TD(buffer),8)(buffer, &elm);
   while (elm) {
      LongStrs_Append(((Buffer)elm)->box, 150ul, str);
      ((Buffer)elm)->box[0UL] = 0;
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(buffer),8)(buffer, &elm);
   }
} /* end FlushBuffer() */


static void MakePath(const X2C_CHAR dir[], X2C_CARD32 dir_len,
                const X2C_CHAR name[], X2C_CARD32 name_len,
                LongStrs_String * path)
{
   LongStrs_Assign(dir, dir_len, path);
   LongStrs_Append(name, name_len, path);
} /* end MakePath() */


extern void H2DFile_SplitName(X2C_CHAR wholeName[], X2C_CARD32 wholeName_len,
                 LongStrs_String * path, LongStrs_String * name,
                LongStrs_String * ext)
{
   X2C_INT32 size;
   X2C_CARD32 pos;
   X2C_BOOLEAN found;
   X2C_PCOPY((void **)&wholeName,wholeName_len);
   LongStrs_Assign("", 1ul, path);
   LongStrs_Assign("", 1ul, name);
   LongStrs_Assign("", 1ul, ext);
   H2DFile_CutSpace(wholeName, wholeName_len);
   size = LongStrs_Length(wholeName, wholeName_len);
   if (size<=0L) goto label;
   Strings_FindPrev(pathSep0->Adr, pathSep0->Len0, wholeName, wholeName_len,
                (X2C_CARD32)(size-1L), &found, &pos);
   if (found) {
      LongStrs_Extract(wholeName, wholeName_len, (X2C_INT32)(pos+1UL),
                (X2C_INT32)((X2C_CARD32)size-pos), name);
      LongStrs_Extract(wholeName, wholeName_len, 0L, (X2C_INT32)pos, path);
   }
   else LongStrs_Assign(wholeName, wholeName_len, name);
   size = LongStrs_Length((*name)->Adr, (*name)->Len0);
   Strings_FindPrev(extSep0->Adr, extSep0->Len0, (*name)->Adr, (*name)->Len0,
                 (X2C_CARD32)(size-1L), &found, &pos);
   if (found) {
      LongStrs_Extract((*name)->Adr, (*name)->Len0, (X2C_INT32)(pos+1UL),
                (X2C_INT32)((X2C_CARD32)size-pos), ext);
      Strings_Delete((*name)->Adr, (*name)->Len0, pos,
                (X2C_CARD32)(size-1L));
   }
   label:;
   X2C_PFREE(wholeName);
} /* end SplitName() */


extern void H2DFile_GetName(X2C_CHAR wholeName[], X2C_CARD32 wholeName_len,
                LongStrs_String * name)
{
   LongStrs_String ext = 0;
   LongStrs_String path = 0;
   H2DFile_SplitName(wholeName, wholeName_len, &path, name, &ext);
   H2DFile_CutSpace((*name)->Adr, (*name)->Len0);
} /* end GetName() */


extern void H2DFile_CreateName(X2C_CHAR path[], X2C_CARD32 path_len,
                X2C_CHAR name[], X2C_CARD32 name_len, X2C_CHAR ext[],
                X2C_CARD32 ext_len, LongStrs_String * fullname)
{
   X2C_BOOLEAN found;
   X2C_CARD32 pos;
   LongStrs_Assign("", 1ul, fullname);
   if (LongStrs_Length(path, path_len)>0L) {
      LongStrs_Assign(path, path_len, fullname);
      LongStrs_Append(pathSep0->Adr, pathSep0->Len0, fullname);
   }
   LongStrs_Append(name, name_len, fullname);
   if (LongStrs_Length(ext, ext_len)>0L) {
      Strings_FindNext(extSep0->Adr, extSep0->Len0, ext, ext_len, 0UL,
                &found, &pos);
      if (!found) LongStrs_Append(extSep0->Adr, extSep0->Len0, fullname);
      LongStrs_Append(ext, ext_len, fullname);
   }
} /* end CreateName() */


extern X2C_BOOLEAN H2DFile_IsAbsolutePath(X2C_CHAR name[],
                X2C_CARD32 name_len)
{
   X2C_CARD32 pos;
   X2C_CARD32 size;
   X2C_CARD32 value_pos;
   X2C_BOOLEAN found;
   size = (X2C_CARD32)LongStrs_Length(name, name_len);
   if (size==0UL) return 0;
   value_pos = 0UL;
   while (value_pos<size && name[value_pos]==' ') ++value_pos;
   Strings_FindNext("/", 2ul, name, name_len, 0UL, &found, &pos);
   if (found && pos==value_pos) return 1;
   Strings_FindNext(":", 2ul, name, name_len, 0UL, &found, &pos);
   if (found) return 1;
   return 0;
} /* end IsAbsolutePath() */


static void append_list(adt_List to, adt_List from)
{
   adt_Element e1 = 0;
   adt_Element e = 0;
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(from),6)(from, &e);
   while (e) {
      X2C_CALL(adt_Find_0,X2C_GET_TD(to),11)(to, e, &e1);
      if (e1==0) X2C_CALL(adt_Insert_0,X2C_GET_TD(to),14)(to, e);
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(from),8)(from, &e);
   }
} /* end append_list() */


static void GetPathesList(X2C_CHAR wholeName[], X2C_CARD32 wholeName_len,
                adt_List * pathes)
{
   adt_Element elm = 0;
   LongStrs_String pattern = 0;
   LongStrs_String ext = 0;
   LongStrs_String path = 0;
   LongStrs_String name = 0;
   X2C_PCOPY((void **)&wholeName,wholeName_len);
   adt_NewList(pathes);
   H2DFile_CutSpace(wholeName, wholeName_len);
   H2DFile_SplitName(wholeName, wholeName_len, &path, &name, &ext);
   H2DFile_CreateName("", 1ul, name->Adr, name->Len0, ext->Adr, ext->Len0,
                &pattern);
   LongStrs_Deallocate(&path);
   LongStrs_Deallocate(&name);
   LongStrs_Deallocate(&ext);
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(PathStore),6)(PathStore, &elm);
   while (elm) {
      if (RegComp_Match(((Group)elm)->expr, pattern->Adr, pattern->Len0,
                0L)) append_list(*pathes, ((Group)elm)->pathes);
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(PathStore),8)(PathStore, &elm);
   }
   LongStrs_Deallocate(&pattern);
   X2C_PFREE(wholeName);
} /* end GetPathesList() */


extern X2C_BOOLEAN H2DFile_Open(X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_INT32 mode, IOChan_ChanId * hand,
                X2C_CARD8 raw_text_mode)
{
   LongStrs_String path = 0;
   adt_List pathes = 0;
   adt_Element dir = 0;
   X2C_INT32 id;
   LongStrs_String anonym = 0;
   GetPathesList(name, name_len, &pathes);
   if (H2DFile_IsAbsolutePath(name, name_len) || X2C_CALL(adt_IsEmpty_1,
                X2C_GET_TD(pathes),4)(pathes)) {
      switch (mode) {
      case 1L:
         RndFile_OpenOld(hand, name, name_len, 0x1U|raw_text_mode,
                &OpenResults);
         break;
      case 2L:
         RndFile_OpenClean(hand, name, name_len, 0x7U|raw_text_mode,
                &OpenResults);
         break;
      case 3L:
         RndFile_OpenOld(hand, name, name_len, 0x3U|raw_text_mode,
                &OpenResults);
         break;
      default:
         X2C_TRAP(X2C_CASE_TRAP);
      } /* end switch */
      if (OpenResults==ChanConsts_opened) {
         adt_Deallocate((adt_Element)pathes);
         return 1;
      }
   }
   else {
      X2C_CALL(adt_FindFirst_0,X2C_GET_TD(pathes),6)(pathes, &dir);
      while (dir) {
         X2C_CALL(adt_Backup_0,X2C_GET_TD(pathes),2)(pathes, &id);
         anonym = ((adt_NamedElement)dir)->name;
         MakePath(anonym->Adr, anonym->Len0, name, name_len, &path);
         switch (mode) {
         case 1L:
            RndFile_OpenOld(hand, path->Adr, path->Len0, 0x1U|raw_text_mode,
                &OpenResults);
            break;
         case 2L:
            RndFile_OpenClean(hand, path->Adr, path->Len0,
                0x7U|raw_text_mode, &OpenResults);
            break;
         case 3L:
            RndFile_OpenOld(hand, path->Adr, path->Len0, 0x3U|raw_text_mode,
                &OpenResults);
            break;
         default:
            X2C_TRAP(X2C_CASE_TRAP);
         } /* end switch */
         LongStrs_Deallocate(&path);
         if (OpenResults==ChanConsts_opened) {
            adt_Deallocate((adt_Element)pathes);
            return 1;
         }
         X2C_CALL(adt_Restore_0,X2C_GET_TD(pathes),1)(pathes, id);
         X2C_CALL(adt_FindNext_0,X2C_GET_TD(pathes),8)(pathes, &dir);
      }
   }
   adt_Deallocate((adt_Element)pathes);
   return 0;
} /* end Open() */


extern void H2DFile_Close(IOChan_ChanId file)
{
   RndFile_Close(&file);
} /* end Close() */


extern void H2DFile_Delete(X2C_CHAR name[], X2C_CARD32 name_len,
                X2C_BOOLEAN * done)
{
   LongStrs_String path = 0;
   adt_List pathes = 0;
   adt_Element dir = 0;
   X2C_INT32 id;
   LongStrs_String anonym = 0;
   *done = 0;
   GetPathesList(name, name_len, &pathes);
   if (X2C_CALL(adt_IsEmpty_1,X2C_GET_TD(pathes),4)(pathes)) {
      FileSys_Remove(name, name_len, done);
   }
   else {
      X2C_CALL(adt_FindFirst_0,X2C_GET_TD(pathes),6)(pathes, &dir);
      while (dir) {
         X2C_CALL(adt_Backup_0,X2C_GET_TD(pathes),2)(pathes, &id);
         anonym = ((adt_NamedElement)dir)->name;
         MakePath(anonym->Adr, anonym->Len0, name, name_len, &path);
         FileSys_Remove(path->Adr, path->Len0, done);
         if (*done) return;
         X2C_CALL(adt_Restore_0,X2C_GET_TD(pathes),1)(pathes, id);
         X2C_CALL(adt_FindNext_0,X2C_GET_TD(pathes),8)(pathes, &dir);
      }
   }
} /* end Delete() */


extern X2C_BOOLEAN H2DFile_RdBin(IOChan_ChanId file, X2C_LOC data[],
                X2C_CARD32 data_len)
{
   RawIO_Read(file, data, data_len);
   return IOChan_ReadResult(file)!=IOConsts_endOfInput;
} /* end RdBin() */

static adt_List RdStr_BufferList;


extern void H2DFile_RdStr(IOChan_ChanId file, LongStrs_String * str)
{
   adt_Element elm = 0;
   Buffer buffer = 0;
   X2C_CALL(adt_Reset_,X2C_GET_TD(RdStr_BufferList),9)(RdStr_BufferList);
   do {
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(RdStr_BufferList),
                8)(RdStr_BufferList, &elm);
      if (elm==0) {
         X2C_NEW(&H2DFile_BufferDesc_desc,(X2C_ADDRESS*) &buffer,
                sizeof(struct H2DFile_BufferDesc),0);
         X2C_CALL(adt_Insert_0,X2C_GET_TD(RdStr_BufferList),
                14)(RdStr_BufferList, (adt_Element)buffer);
         X2C_CALL(adt_FindLast_0,X2C_GET_TD(RdStr_BufferList),
                5)(RdStr_BufferList, &elm);
      }
      buffer = (Buffer)elm;
      buffer->box[0UL] = 0;
      TextIO_ReadString(file, buffer->box, 150ul);
   } while (!(IOChan_ReadResult(file)==IOConsts_endOfLine || IOChan_ReadResult(file)==IOConsts_endOfInput));
   FlushBuffer(RdStr_BufferList, str);
   TextIO_SkipLine(file);
   if (IOChan_ReadResult(file)==IOConsts_endOfInput && (*str)->Adr[0UL]==0) {
      LongStrs_Deallocate(str);
   }
} /* end RdStr() */


extern void H2DFile_WrStr(IOChan_ChanId file, X2C_CHAR str[],
                X2C_CARD32 str_len)
{
   TextIO_WriteString(file, str, str_len);
} /* end WrStr() */


extern void H2DFile_WrStrLn(IOChan_ChanId file, X2C_CHAR str[],
                X2C_CARD32 str_len)
{
   TextIO_WriteLn(file);
   TextIO_WriteString(file, str, str_len);
} /* end WrStrLn() */


extern void H2DFile_SpaceStr(LongStrs_String * str, X2C_INT32 number)
{
   LongStrs_Assign("", 1ul, str);
   while (number>0L) {
      LongStrs_AppendChar(' ', str);
      --number;
   }
} /* end SpaceStr() */


static X2C_BOOLEAN IsDivideChar(X2C_CHAR char0)
{
   X2C_INT32 i;
   X2C_INT32 tmp;
   tmp = LongStrs_Length1(H2DFile_DivideChars)-1L;
   i = 0L;
   if (i<=tmp) for (;; i++) {
      if (H2DFile_DivideChars->Adr[i]==char0) return 1;
      if (i==tmp) break;
   } /* end for */
   return 0;
} /* end IsDivideChar() */


static X2C_INT32 FindDivideChar(const X2C_CHAR str[], X2C_CARD32 str_len,
                X2C_INT32 startPos)
{
   X2C_INT32 size;
   X2C_INT32 pos;
   size = LongStrs_Length(str, str_len);
   pos = startPos;
   for (;;) {
      if (pos>=size) return -1L;
      if (IsDivideChar(str[pos])) {
         if (pos+1L<size && !IsDivideChar(str[pos+1L])) return pos;
      }
      ++pos;
   }
   return 0;
} /* end FindDivideChar() */


static void SplitStr(X2C_CHAR str[], X2C_CARD32 str_len,
                LongStrs_String * extStr, X2C_INT32 size)
{
   X2C_INT32 prevPos;
   X2C_INT32 pos;
   prevPos = 0L;
   LongStrs_Deallocate(extStr);
   if (Length(str, str_len)>size) {
      pos = FindDivideChar(str, str_len, 0L);
      if (pos==-1L) return;
      if (pos>=size) {
         LongStrs_Extract(str, str_len, 0L, pos+1L, extStr);
         Strings_Delete(str, str_len, 0UL, (X2C_CARD32)(pos+1L));
      }
      else {
         while (pos!=-1L && pos<size) {
            prevPos = pos;
            pos = FindDivideChar(str, str_len, pos+1L);
         }
         LongStrs_Extract(str, str_len, 0L, prevPos+1L, extStr);
         Strings_Delete(str, str_len, 0UL, (X2C_CARD32)(prevPos+1L));
      }
   }
} /* end SplitStr() */


static void CarveStr(X2C_CHAR str[], X2C_CARD32 str_len, adt_List * buffer,
                X2C_INT32 tab)
{
   adt_NamedElement nelm = 0;
   X2C_PCOPY((void **)&str,str_len);
   adt_NewNamedElement(&nelm, "", 1ul);
   adt_NewList(buffer);
   SplitStr(str, str_len, &nelm->name, H2DFile_SizeOutputLine);
   while (nelm->name) {
      X2C_CALL(adt_Insert_0,X2C_GET_TD(*buffer),14)(*buffer,
                (adt_Element)nelm);
      adt_NewNamedElement(&nelm, "", 1ul);
      SplitStr(str, str_len, &nelm->name, H2DFile_SizeOutputLine-tab);
   }
   LongStrs_Assign(str, str_len, &nelm->name);
   X2C_CALL(adt_Insert_0,X2C_GET_TD(*buffer),14)(*buffer, (adt_Element)nelm);
   X2C_PFREE(str);
} /* end CarveStr() */


static X2C_INT32 FlushWriteBuffer(IOChan_ChanId file, adt_List * buffer,
                X2C_INT32 tab)
{
   adt_Element elm = 0;
   X2C_INT32 numberLine;
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   numberLine = 0L;
   H2DFile_SpaceStr(&BlankString, tab);
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(*buffer),6)(*buffer, &elm);
   if (elm) {
      anonym = ((adt_NamedElement)elm)->name;
      H2DFile_WrStrLn(file, anonym->Adr, anonym->Len0);
      numberLine = 1L;
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(*buffer),8)(*buffer, &elm);
      while (elm) {
         LongStrs_Insert(BlankString->Adr, BlankString->Len0, 0L,
                &((adt_NamedElement)elm)->name);
         anonym0 = ((adt_NamedElement)elm)->name;
         H2DFile_WrStrLn(file, anonym0->Adr, anonym0->Len0);
         ++numberLine;
         X2C_CALL(adt_FindNext_0,X2C_GET_TD(*buffer),8)(*buffer, &elm);
      }
   }
   CleanBuffer(buffer);
   return numberLine;
} /* end FlushWriteBuffer() */


extern X2C_INT32 H2DFile_FWriteStrLn(IOChan_ChanId file, X2C_CHAR str[],
                X2C_CARD32 str_len, X2C_INT32 leadtab, X2C_INT32 tab)
{
   adt_List buffer = 0;
   X2C_INT32 numberLine;
   H2DFile_SpaceStr(&outStr, leadtab);
   LongStrs_Append(str, str_len, &outStr);
   if (LongStrs_Length(outStr->Adr,
                outStr->Len0)<=H2DFile_SizeOutputLine || H2DFile_UnlimitedSizeOutputLin)
                 {
      H2DFile_WrStrLn(file, outStr->Adr, outStr->Len0);
      numberLine = 1L;
   }
   else {
      CarveStr(outStr->Adr, outStr->Len0, &buffer, tab);
      numberLine = FlushWriteBuffer(file, &buffer, tab);
   }
   return numberLine;
} /* end FWriteStrLn() */


static X2C_INT32 FlushWriteBuffer0(IOChan_ChanId file, adt_List * buffer,
                X2C_INT32 tab)
{
   adt_Element elm = 0;
   X2C_INT32 numberLine;
   LongStrs_String anonym = 0;
   LongStrs_String anonym0 = 0;
   numberLine = 0L;
   H2DFile_SpaceStr(&BlankString, tab);
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(*buffer),6)(*buffer, &elm);
   if (elm) {
      anonym = ((adt_NamedElement)elm)->name;
      H2DFile_WrStr(file, anonym->Adr, anonym->Len0);
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(*buffer),8)(*buffer, &elm);
      while (elm) {
         LongStrs_Insert(BlankString->Adr, BlankString->Len0, 0L,
                &((adt_NamedElement)elm)->name);
         anonym0 = ((adt_NamedElement)elm)->name;
         H2DFile_WrStrLn(file, anonym0->Adr, anonym0->Len0);
         ++numberLine;
         X2C_CALL(adt_FindNext_0,X2C_GET_TD(*buffer),8)(*buffer, &elm);
      }
   }
   return numberLine;
} /* end FlushWriteBuffer() */


extern X2C_INT32 H2DFile_FWriteStr(IOChan_ChanId file, X2C_CHAR str[],
                X2C_CARD32 str_len, X2C_INT32 leadtab, X2C_INT32 tab)
{
   adt_List buffer = 0;
   X2C_INT32 numberLine;
   H2DFile_SpaceStr(&outStr, leadtab);
   LongStrs_Append(str, str_len, &outStr);
   if (LongStrs_Length(outStr->Adr,
                outStr->Len0)<=H2DFile_SizeOutputLine || H2DFile_UnlimitedSizeOutputLin)
                 {
      H2DFile_WrStr(file, outStr->Adr, outStr->Len0);
      numberLine = 0L;
   }
   else {
      CarveStr(outStr->Adr, outStr->Len0, &buffer, tab);
      numberLine = FlushWriteBuffer0(file, &buffer, tab);
   }
   return numberLine;
} /* end FWriteStr() */


extern X2C_BOOLEAN H2DFile_Exist(X2C_CHAR filename[],
                X2C_CARD32 filename_len)
{
   IOChan_ChanId file;
   if (H2DFile_Open(filename, filename_len, 1L, &file, 0x8U)) {
      H2DFile_Close(file);
      return 1;
   }
   else if (OpenResults==ChanConsts_alreadyOpen) return 1;
   else return 0;
   return 0;
} /* end Exist() */


static void GetGroup(X2C_CHAR str[], X2C_CARD32 str_len, Group * group)
{
   X2C_CARD32 pos;
   X2C_BOOLEAN found;
   LongStrs_String expr = 0;
   X2C_INT32 res;
   Strings_FindNext("=", 2ul, str, str_len, 0UL, &found, &pos);
   if (found) {
      NewGroup(group);
      expr = 0;
      LongStrs_Extract(str, str_len, 0L, (X2C_INT32)pos, &expr);
      Strings_Delete(str, str_len, 0UL, pos+1UL);
      H2DFile_CutSpace(expr->Adr, expr->Len0);
      RegComp_Compile(expr->Adr, expr->Len0, &(*group)->expr, &res);
      if (res>0L) {
         X2C_CALL(adt_Insert_0,X2C_GET_TD(PathStore),14)(PathStore,
                (adt_Element)*group);
      }
      else *group = 0;
   }
} /* end GetGroup() */


static void AdaptationPath(LongStrs_String * path)
{
   X2C_INT32 size;
   if (*path) {
      H2DFile_CutSpace((*path)->Adr, (*path)->Len0);
      size = Length((*path)->Adr, (*path)->Len0);
      if (size && (*path)->Adr[size-1L]!=pathSep0->Adr[0UL]) {
         LongStrs_AppendChar(pathSep, path);
      }
   }
} /* end AdaptationPath() */


static void ParsePathes(X2C_CHAR str[], X2C_CARD32 str_len, Group group)
{
   X2C_BOOLEAN found;
   X2C_CARD32 pos;
   adt_NamedElement path = 0;
   X2C_PCOPY((void **)&str,str_len);
   if (group) {
      H2DFile_CutSpace(str, str_len);
      Strings_FindNext(";", 2ul, str, str_len, 0UL, &found, &pos);
      while (found) {
         X2C_NEW(&adt_NamedElementDesc_desc,(X2C_ADDRESS*) &path,
                sizeof(struct adt_NamedElementDesc),0);
         LongStrs_Extract(str, str_len, 0L, (X2C_INT32)pos, &path->name);
         AdaptationPath(&path->name);
         X2C_CALL(adt_Insert_0,X2C_GET_TD(group->pathes),14)(group->pathes,
                (adt_Element)path);
         Strings_Delete(str, str_len, 0UL, pos+1UL);
         Strings_FindNext(";", 2ul, str, str_len, 0UL, &found, &pos);
      }
      H2DFile_CutSpace(str, str_len);
      if (Length(str, str_len)) {
         X2C_NEW(&adt_NamedElementDesc_desc,(X2C_ADDRESS*) &path,
                sizeof(struct adt_NamedElementDesc),0);
         LongStrs_Assign(str, str_len, &path->name);
         AdaptationPath(&path->name);
         X2C_CALL(adt_Insert_0,X2C_GET_TD(group->pathes),14)(group->pathes,
                (adt_Element)path);
      }
   }
   X2C_PFREE(str);
} /* end ParsePathes() */


static void LoadRedFile(void)
{
   LongStrs_String str = 0;
   IOChan_ChanId redfile;
   Group group = 0;
   X2C_CARD8 res;
   LongStrs_String ext = 0;
   LongStrs_String path = 0;
   LongStrs_String name = 0;
   adt_Element elm = 0;
   adt_List anonym = 0;
   name = 0;
   H2DFile_ProgramName = 0;
   path = 0;
   ext = 0;
   group = 0;
   X2C_NEW(&adt_NamedElementDesc_desc,(X2C_ADDRESS*) &curDir,
                sizeof(struct adt_NamedElementDesc),0);
   adt_NewList(&PathStore);
   LongStrs_Assign("", 1ul, &H2DFile_CurrentDir);
   X2C_CALL(adt_SetName_,X2C_GET_TD(curDir),1)(curDir,
                H2DFile_CurrentDir->Adr, H2DFile_CurrentDir->Len0);
   LongStrs_Allocate(&name, (X2C_INT32)(ProgEnv_ProgramNameLength()+1UL));
   ProgEnv_ProgramName(name->Adr, name->Len0);
   H2DFile_SplitName(name->Adr, name->Len0, &path, &H2DFile_ProgramName,
                &ext);
   H2DFile_CreateName("", 1ul, H2DFile_ProgramName->Adr,
                H2DFile_ProgramName->Len0, "red", 4ul, &name);
   RndFile_OpenOld(&redfile, name->Adr, name->Len0, 0x9U, &res);
   if (res) {
      H2DFile_CreateName(path->Adr, path->Len0, H2DFile_ProgramName->Adr,
                H2DFile_ProgramName->Len0, "red", 4ul, &name);
      RndFile_OpenOld(&redfile, name->Adr, name->Len0, 0x9U, &res);
   }
   if (res==ChanConsts_opened) {
      H2DFile_RdStr(redfile, &str);
      while (str) {
         if (str->Adr[0UL]!='%') {
            GetGroup(str->Adr, str->Len0, &group);
            ParsePathes(str->Adr, str->Len0, group);
         }
         H2DFile_RdStr(redfile, &str);
      }
      RndFile_Close(&redfile);
   }
   X2C_CALL(adt_FindFirst_0,X2C_GET_TD(PathStore),6)(PathStore, &elm);
   while (elm) {
      anonym = ((Group)elm)->pathes;
      X2C_CALL(adt_Insert_0,X2C_GET_TD(anonym),14)(anonym,
                (adt_Element)curDir);
      X2C_CALL(adt_FindNext_0,X2C_GET_TD(PathStore),8)(PathStore, &elm);
   }
   H2DFile_CreateName("", 1ul, H2DFile_ProgramName->Adr,
                H2DFile_ProgramName->Len0, "cfg", 4ul, &str);
   LongStrs_Append("=", 2ul, &str);
   LongStrs_Append(path->Adr, path->Len0, &str);
   GetGroup(str->Adr, str->Len0, &group);
   ParsePathes(str->Adr, str->Len0, group);
   H2DFile_CreateName("", 1ul, H2DFile_ProgramName->Adr,
                H2DFile_ProgramName->Len0, "msg", 4ul, &str);
   LongStrs_Append("=", 2ul, &str);
   LongStrs_Append(path->Adr, path->Len0, &str);
   GetGroup(str->Adr, str->Len0, &group);
   ParsePathes(str->Adr, str->Len0, group);
   LongStrs_Deallocate(&ext);
   LongStrs_Deallocate(&name);
   LongStrs_Deallocate(&path);
   LongStrs_Deallocate(&str);
} /* end LoadRedFile() */


static void * H2DFile_offs[] = {
   &H2DFile_CurrentDir,
   &H2DFile_DivideChars,
   &H2DFile_ProgramName,
   &curDir,
   &PathStore,
   &pathSep0,
   &extSep0,
   &BlankString,
   &outStr,
   &RdStr_BufferList,
   X2C_OFS_END
};
static X2C_PROC H2DFile_cmds[] = { 0 };
static X2C_CHAR * H2DFile_cnms[] = { 0 };
struct X2C_MD_STR H2DFile_desc = {
  0, 0, "H2DFile",H2DFile_offs,H2DFile_cmds,H2DFile_cnms,
                &H2DFile_GroupDesc_desc
};

extern void H2DFile_BEGIN(void)
{
   static int H2DFile_init = 0;
   if (H2DFile_init) return;
   H2DFile_init = 1;
   ProgEnv_BEGIN();
   RegComp_BEGIN();
   LongStrs_BEGIN();
   FileSys_BEGIN();
   IOConsts_BEGIN();
   IOChan_BEGIN();
   TextIO_BEGIN();
   RawIO_BEGIN();
   ChanConsts_BEGIN();
   RndFile_BEGIN();
   Strings_BEGIN();
   adt_BEGIN();
   Printf_BEGIN();
   X2C_MODULE(&H2DFile_desc);
   H2DFile_UnlimitedSizeOutputLin = 0;
   adt_NewList(&RdStr_BufferList);
   H2DFile_DivideChars = 0;
   extSep0 = 0;
   LongStrs_AppendChar(extSep, &extSep0);
   pathSep0 = 0;
   LongStrs_AppendChar(pathSep, &pathSep0);
   H2DFile_SizeOutputLine = 86L;
   BlankString = 0;
   outStr = 0;
   LoadRedFile();
}

