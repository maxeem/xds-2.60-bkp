/* "@(#)LongStrs.c Nov  7 22:56:04 2022" */
/* Generated by XDS Oberon-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef LongStrs_H_
#include "LongStrs.h"
#endif
#define LongStrs_C_
#ifndef WholeStr_H_
#include "WholeStr.h"
#endif
#ifndef LongStr_H_
#include "LongStr.h"
#endif
#ifndef Strings_H_
#include "Strings.h"
#endif
#ifndef Printf_H_
#include "Printf.h"
#endif

extern struct X2C_MD_STR LongStrs_desc;
#define LongStrs_segment_size 10

#define LongStrs_short_string_size 100

struct LongStrs_StringHolderDesc;
extern struct X2C_TD_STR LongStrs_StringHolderDesc_desc;

typedef struct LongStrs_StringHolderDesc * StringHolder;


struct LongStrs_StringHolderDesc {
   LongStrs_String str;
   X2C_INT32 seg_len;
   StringHolder next;
};
static X2C_PROC LongStrs_StringHolderDesc_proc[] = {
   0
};
static void * LongStrs_StringHolderDesc_offs[] = {
   X2C_OFS(struct LongStrs_StringHolderDesc,str),
   X2C_OFS(struct LongStrs_StringHolderDesc,next),
   X2C_OFS_END
};
struct X2C_TD_STR LongStrs_StringHolderDesc_desc = {
   sizeof(struct LongStrs_StringHolderDesc), "StringHolderDesc",
   &LongStrs_desc, 0, 0, 0,
   { &LongStrs_StringHolderDesc_desc, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0 },
   LongStrs_StringHolderDesc_proc, LongStrs_StringHolderDesc_offs, 0, 0, 0,
                &LongStrs_StringHolderDesc_desc, 0x93678150lu
};

struct LongStrs_StringStoragePart;
extern struct X2C_TD_STR LongStrs_StringStoragePart_des;


struct LongStrs_StringStoragePart {
   StringHolder putptr;
   StringHolder getptr;
};
static X2C_PROC LongStrs_StringStoragePart_pro[] = {
   0
};
static void * LongStrs_StringStoragePart_off[] = {
   X2C_OFS(struct LongStrs_StringStoragePart,putptr),
   X2C_OFS(struct LongStrs_StringStoragePart,getptr),
   X2C_OFS_END
};
struct X2C_TD_STR LongStrs_StringStoragePart_des = {
   sizeof(struct LongStrs_StringStoragePart), "StringStoragePart",
   &LongStrs_desc, &LongStrs_StringHolderDesc_desc, 0, 0,
   { &LongStrs_StringStoragePart_des, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                0, 0 },
   LongStrs_StringStoragePart_pro, LongStrs_StringStoragePart_off, 0, 0, 0,
                &LongStrs_StringStoragePart_des, 0x93678150lu
};

static StringHolder LongStringStorage;

static struct LongStrs_StringStoragePart StringStorage[100];

static LongStrs_String __str;

static StringHolder junk;


extern void LongStrs_Deallocate(LongStrs_String * s)
{
   StringHolder sh = 0;
   X2C_INT32 seg_len;
   if (*s==0) return;
   seg_len = X2C_DIV((*s)->Len0,10L);
   if (seg_len>100L) {
      sh = LongStringStorage;
      while (sh && sh->str) sh = sh->next;
      if (sh==0) {
         X2C_NEW(&LongStrs_StringHolderDesc_desc,(X2C_ADDRESS*) &sh,
                sizeof(struct LongStrs_StringHolderDesc),0);
         sh->next = LongStringStorage;
         LongStringStorage = sh;
      }
      sh->str = *s;
      sh->seg_len = seg_len;
   }
   else {
      if (StringStorage[seg_len-1L].putptr->next==StringStorage[seg_len-1L]
                .getptr) {
         X2C_NEW(&LongStrs_StringHolderDesc_desc,(X2C_ADDRESS*) &sh,
                sizeof(struct LongStrs_StringHolderDesc),0);
         sh->next = StringStorage[seg_len-1L].getptr;
         StringStorage[seg_len-1L].putptr->next = sh;
      }
      StringStorage[seg_len-1L].putptr->str = *s;
      StringStorage[seg_len-1L].putptr = StringStorage[seg_len-1L]
                .putptr->next;
   }
   *s = 0;
} /* end Deallocate() */


extern void LongStrs_Allocate(LongStrs_String * s, X2C_INT32 len)
{
   StringHolder sh = 0;
   X2C_INT32 i0;
   X2C_INT32 seg_len;
   X2C_INDEX tmp[1];
   sh = 0;
   seg_len = X2C_DIV(len,10L)+1L;
   if (*s) {
      if (X2C_DIV((*s)->Len0,10L)>=seg_len) return;
      LongStrs_Deallocate(s);
   }
   if (seg_len>100L) {
      sh = LongStringStorage;
      while (sh && sh->seg_len<seg_len) sh = sh->next;
   }
   else {
      i0 = seg_len-1L;
      while (i0<100L && StringStorage[i0].getptr==StringStorage[i0].putptr) {
         ++i0;
      }
      if (i0<100L) {
         sh = StringStorage[i0].getptr;
         StringStorage[i0].getptr = StringStorage[i0].getptr->next;
      }
   }
   if (sh==0) {
      X2C_NEW_OPEN(x2c_td_null,(X2C_ADDRESS*)s,1u,
                (tmp[0] = (size_t)(seg_len*10L),tmp),1u,0);
   }
   else {
      *s = sh->str;
      sh->str = 0;
      sh->seg_len = 0L;
   }
} /* end Allocate() */


extern X2C_INT32 LongStrs_Length(X2C_CHAR s[], X2C_CARD32 s_len)
{
   return X2C_LENGTH(s,s_len);
} /* end Length() */


extern X2C_INT32 LongStrs_Length1(LongStrs_String s)
{
   if (s==0) return 0L;
   else return X2C_LENGTH(s->Adr,s->Len0);
   return 0;
} /* end Length1() */


static void MakeDest(LongStrs_String * d, X2C_INT32 ReqSize)
{
   LongStrs_String x = 0;
   x = *d;
   LongStrs_Allocate(d, ReqSize);
   if (x!=*d) {
      (*d)->Adr[0UL] = 0x0U ;
      if (x) X2C_COPY(x->Adr,x->Len0,(*d)->Adr,(*d)->Len0);
   }
} /* end MakeDest() */


extern void LongStrs_Assign(X2C_CHAR s[], X2C_CARD32 s_len,
                LongStrs_String * d)
{
   X2C_INT32 i0;
   X2C_INT32 l;
   if (*d) {
      l = (*d)->Len0;
      i0 = 0L;
      while (i0<l && s[i0]) {
         (*d)->Adr[i0] = s[i0];
         ++i0;
      }
      if (i0<l) (*d)->Adr[i0] = 0x0U ;
      else {
         LongStrs_Allocate(d, LongStrs_Length(s, s_len)+1L);
         X2C_COPY(s,s_len,(*d)->Adr,(*d)->Len0);
      }
   }
   else {
      LongStrs_Allocate(d, LongStrs_Length(s, s_len)+1L);
      X2C_COPY(s,s_len,(*d)->Adr,(*d)->Len0);
   }
} /* end Assign() */


extern void LongStrs_Extract(X2C_CHAR s[], X2C_CARD32 s_len,
                X2C_INT32 startIndex, X2C_INT32 numberToExtract,
                LongStrs_String * d)
{
   MakeDest(d, numberToExtract+1L);
   Strings_Extract(s, s_len, (X2C_CARD32)startIndex,
                (X2C_CARD32)numberToExtract, (*d)->Adr, (*d)->Len0);
} /* end Extract() */


extern void LongStrs_Insert(X2C_CHAR s[], X2C_CARD32 s_len,
                X2C_INT32 startIndex, LongStrs_String * d)
{
   MakeDest(d, LongStrs_Length(s, s_len)+LongStrs_Length1(*d)+1L);
   Strings_Insert(s, s_len, (X2C_CARD32)startIndex, (*d)->Adr, (*d)->Len0);
} /* end Insert() */


extern void LongStrs_Delete(X2C_CHAR stringVar[], X2C_CARD32 stringVar_len,
                X2C_INT32 startIndex, X2C_INT32 numberToDelete)
{
   Strings_Delete(stringVar, stringVar_len, (X2C_CARD32)startIndex,
                (X2C_CARD32)numberToDelete);
} /* end Delete() */


extern void LongStrs_Append(X2C_CHAR s[], X2C_CARD32 s_len,
                LongStrs_String * d)
{
   X2C_INT32 j;
   X2C_INT32 i0;
   X2C_INT32 k;
   X2C_INT32 l;
   LongStrs_String x = 0;
   if (*d) {
      l = (*d)->Len0;
      i0 = 0L;
      j = 0L;
      k = s_len;
      while (i0<l && (*d)->Adr[i0]) ++i0;
      if (i0<l) {
         while ((i0<l && j<k) && s[j]) {
            (*d)->Adr[i0] = s[j];
            ++i0;
            ++j;
         }
         if (i0<l) (*d)->Adr[i0] = 0x0U ;
         else {
            LongStrs_Allocate(&x, LongStrs_Length(s,
                s_len)+LongStrs_Length((*d)->Adr, (*d)->Len0)+1L);
            (*d)->Adr[l-1L] = 0x0U ;
            X2C_COPY((*d)->Adr,(*d)->Len0,x->Adr,x->Len0);
            LongStrs_Deallocate(d);
            *d = x;
            --i0;
            --j;
            while (j<k && s[j]) {
               (*d)->Adr[i0] = s[j];
               ++i0;
               ++j;
            }
            (*d)->Adr[i0] = 0x0U ;
         }
      }
      else {
         Printf_printf("Internal error in LongStrs\\n", 29ul, 0, 0ul);
         X2C_HALT(1UL);
      }
   }
   else {
      LongStrs_Allocate(d, LongStrs_Length(s, s_len)+1L);
      X2C_COPY(s,s_len,(*d)->Adr,(*d)->Len0);
   }
} /* end Append() */


extern void LongStrs_Concat(X2C_CHAR s1[], X2C_CARD32 s1_len, X2C_CHAR s2[],
                X2C_CARD32 s2_len, LongStrs_String * d)
{
   MakeDest(d, LongStrs_Length(s1, s1_len)+LongStrs_Length(s2, s2_len)+1L);
   Strings_Concat(s1, s1_len, s2, s2_len, (*d)->Adr, (*d)->Len0);
} /* end Concat() */


extern void LongStrs_AppendChar(X2C_CHAR ch, LongStrs_String * d)
{
   X2C_CHAR str[2];
   str[0UL] = ch;
   str[1UL] = 0x0U ;
   LongStrs_Append(str, 2ul, d);
} /* end AppendChar() */


extern void LongStrs_CutSpace(X2C_CHAR s[], X2C_CARD32 s_len)
{
   X2C_INT16 n;
   X2C_INT16 i0;
   i0 = 0;
   n = 0;
   while ((X2C_INT32)i0<s_len && s[i0]) {
      if (s[i0]!=' ' && s[i0]!='\011') {
         s[n] = s[i0];
         ++n;
      }
      ++i0;
   }
   if ((X2C_INT32)n<s_len) s[n] = 0x0U ;
} /* end CutSpace() */


extern void LongStrs_Capitalize(X2C_CHAR s[], X2C_CARD32 s_len)
{
   Strings_Capitalize(s, s_len);
} /* end Capitalize() */


extern X2C_INT32 LongStrs_FindPos(X2C_CHAR str[], X2C_CARD32 str_len,
                X2C_CHAR ch)
{
   X2C_INT32 size;
   X2C_INT32 pos;
   pos = 0L;
   size = LongStrs_Length(str, str_len);
   for (;;) {
      if (pos==size) return -1L;
      if (str[pos]==ch) return pos;
      ++pos;
   }
   return 0;
} /* end FindPos() */


extern X2C_INT32 LongStrs_BackFindPos(X2C_CHAR str[], X2C_CARD32 str_len,
                X2C_CHAR ch)
{
   X2C_INT32 pos;
   X2C_INT32 size;
   size = LongStrs_Length(str, str_len);
   pos = size-1L;
   for (;;) {
      if (pos<0L) return -1L;
      if (str[pos]==ch) return pos;
      --pos;
   }
   return 0;
} /* end BackFindPos() */


extern void LongStrs_Fill(LongStrs_String * str, X2C_CHAR ch,
                X2C_INT32 number)
{
   LongStrs_Assign("", 1ul, str);
   if (number>0L) {
      while (number>0L) {
         LongStrs_AppendChar(ch, str);
         --number;
      }
   }
} /* end Fill() */


extern void LongStrs_IntToStr(X2C_INT32 int0, LongStrs_String * str)
{
   LongStrs_String intStr = 0;
   X2C_INDEX tmp[1];
   X2C_NEW_OPEN(x2c_td_null,(X2C_ADDRESS*) &intStr,1u,
                (tmp[0] = (size_t)(X2C_DIV(int0,10L)+2L),tmp),1u,0);
   WholeStr_IntToStr(int0, intStr->Adr, intStr->Len0);
   LongStrs_Append(intStr->Adr, intStr->Len0, str);
} /* end IntToStr() */


extern void LongStrs_RealToStr(X2C_LONGREAL real, LongStrs_String * str)
{
   X2C_INT32 pos;
   X2C_CHAR a[32];
   LongStr_RealToStr(real, a, 32ul);
   LongStrs_Assign(a, 32ul, str);
   if (LongStrs_FindPos((*str)->Adr, (*str)->Len0, '.')==-1L) {
      pos = LongStrs_FindPos((*str)->Adr, (*str)->Len0, 'E');
      if (pos==-1L) pos = LongStrs_FindPos((*str)->Adr, (*str)->Len0, 'e');
      if (pos==-1L) LongStrs_Append(".0", 3ul, str);
      else LongStrs_Insert(".0", 3ul, pos, str);
   }
} /* end RealToStr() */

static X2C_INT32 i;


static void * LongStrs_offs[] = {
   &LongStringStorage,
   X2C_OFS_ARR,
   &StringStorage[99],
   X2C_OFS_REC,
   &LongStrs_StringStoragePart_des,
   &StringStorage[0],
   &__str,
   &junk,
   X2C_OFS_END
};
static X2C_PROC LongStrs_cmds[] = { 0 };
static X2C_CHAR * LongStrs_cnms[] = { 0 };
struct X2C_MD_STR LongStrs_desc = {
  0, 0, "LongStrs",LongStrs_offs,LongStrs_cmds,LongStrs_cnms,
                &LongStrs_StringStoragePart_des
};

extern void LongStrs_BEGIN(void)
{
   static int LongStrs_init = 0;
   if (LongStrs_init) return;
   LongStrs_init = 1;
   Printf_BEGIN();
   Strings_BEGIN();
   LongStr_BEGIN();
   WholeStr_BEGIN();
   X2C_MODULE(&LongStrs_desc);
   LongStringStorage = 0;
   junk = 0;
   __str = 0;
   for (i = 0L; i<=99L; i++) {
      X2C_NEW(&LongStrs_StringHolderDesc_desc,
                (X2C_ADDRESS*) &StringStorage[i].putptr,
                sizeof(struct LongStrs_StringHolderDesc),0);
      X2C_NEW(&LongStrs_StringHolderDesc_desc,
                (X2C_ADDRESS*) &StringStorage[i].putptr->next,
                sizeof(struct LongStrs_StringHolderDesc),0);
      StringStorage[i].putptr->next->next = StringStorage[i].putptr;
      StringStorage[i].getptr = StringStorage[i].putptr;
   } /* end for */
}

